<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الإدارة المتكامل الاحترافي - تطوير أحمد الطيب</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS (Excel Library) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        brand: {
                            900: '#1e1b4b',
                            800: '#312e81',
                            600: '#4f46e5',
                            500: '#6366f1',
                            400: '#818cf8',
                            50:  '#eef2ff'
                        },
                        accent: {
                            500: '#f59e0b',
                            600: '#d97706'
                        },
                        cafe: {
                            600: '#8c6b5d',
                            50: '#fdf8f6'
                        },
                        showroom: {
                            600: '#0f766e',
                            50: '#f0fdfa'
                        },
                        success: {
                            600: '#16a34a',
                            50: '#f0fdf4'
                        }
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.15)',
                    }
                }
            }
        }
    </script>

    <style>
        body { background: #f8fafc; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-pulse:active { transform: scale(0.95); }

        /* Table Fixed Header Styles */
        .table-container {
            overflow-y: auto;
            max-height: 100%;
            border-radius: 0.5rem;
        }
        thead th {
            position: sticky;
            top: 0;
            background-color: #f8fafc; /* slate-50 */
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        /* تحسين التفاف النص في الطباعة والعرض */
        .wrap-text {
            white-space: normal !important;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        @media print {
            body { background: white; overflow: visible; height: auto; }
            header, aside, .no-print { display: none !important; }
            #mainContainer { overflow: visible; position: static; }
            .print-section { display: block !important; page-break-after: always; }
            table { width: 100%; border-collapse: collapse; font-size: 10pt; }
            th, td { border: 1px solid #ddd; padding: 4px; text-align: center; }
            thead { background: #eee !important; -webkit-print-color-adjust: exact; }
            .bg-red-50 { background-color: #ffebee !important; -webkit-print-color-adjust: exact; }
            .bg-green-50 { background-color: #e8f5e9 !important; -webkit-print-color-adjust: exact; }
            .print-footer { position: fixed; bottom: 0; width: 100%; text-align: center; font-size: 9pt; padding: 10px; border-top: 1px solid #ddd; }
            
            /* تأكيد التفاف النص في الطباعة */
            .wrap-text { white-space: normal !important; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden font-sans text-slate-800">

<!-- GLOBAL HEADER -->
<header class="bg-brand-900 text-white shadow-lg z-50 flex-shrink-0 no-print">
    <div class="flex items-center justify-between px-4 py-3">
        <div class="flex items-center gap-3 cursor-pointer" onclick="switchView('home')">
            <div class="w-10 h-10 rounded-xl bg-brand-500/20 border border-brand-500/30 flex items-center justify-center text-accent-500">
                <i class="fa-solid fa-layer-group text-xl"></i>
            </div>
            <div>
                <h1 class="text-lg font-black leading-none">نظام الإدارة المتكامل - تطوير أحمد الطيب</h1>
                <span class="text-[10px] text-slate-400 font-bold tracking-wide">نسخة محسنة V2.4</span>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <button onclick="toggleLanguage()" class="bg-amber-600 hover:bg-amber-700 text-white px-3 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2 shadow-lg shadow-amber-900/50 btn-pulse" title="تغيير اللغة">
                <i class="fa-solid fa-globe"></i> <span class="hidden sm:inline" id="lang-text">English</span>
            </button>
            <button onclick="saveAllDataManual()" class="bg-brand-600 hover:bg-brand-500 text-white px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2 shadow-lg shadow-brand-900/50 btn-pulse">
                <i class="fa-solid fa-save"></i> <span class="hidden sm:inline">حفظ التغييرات</span>
            </button>
            <button onclick="goToHome()" class="bg-slate-700 hover:bg-slate-600 text-white w-10 h-10 rounded-xl flex items-center justify-center transition btn-pulse" title="الرئيسية">
                <i class="fa-solid fa-house"></i>
            </button>
        </div>
    </div>
</header>

<!-- MAIN CONTENT CONTAINER -->
<div id="mainContainer" class="flex-1 overflow-hidden relative bg-slate-100">

    <!-- VIEW: HOME (DASHBOARD) -->
    <div id="view-home" class="absolute inset-0 flex flex-col items-center justify-center p-6 fade-in z-30 bg-slate-50 overflow-y-auto">
        <div class="text-center mb-10">
            <h2 class="text-3xl sm:text-4xl font-black text-brand-900 mb-2">لوحة القيادة والمتابعة</h2>
            <p class="text-slate-500 font-medium">نظرة عامة على حالة العمل</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 w-full max-w-7xl">
            <div onclick="switchView('inventory')" class="group cursor-pointer bg-white p-6 rounded-3xl shadow-glass border border-slate-200 hover:border-brand-500 hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <div class="w-12 h-12 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center text-2xl group-hover:scale-110 transition">
                        <i class="fa-solid fa-boxes-stacked"></i>
                    </div>
                    <span id="dash-inv-count" class="text-3xl font-black text-slate-800">0</span>
                </div>
                <h3 class="text-lg font-bold text-slate-700">الجرد العام</h3>
                <p class="text-xs text-slate-400 mt-1">إدارة الكميات وحذف الأصناف</p>
            </div>

            <div onclick="switchView('expiry')" class="group cursor-pointer bg-white p-6 rounded-3xl shadow-glass border border-slate-200 hover:border-accent-500 hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1">
                 <div class="flex justify-between items-start mb-4">
                    <div class="w-12 h-12 rounded-2xl bg-amber-50 text-amber-600 flex items-center justify-center text-2xl group-hover:scale-110 transition">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                    </div>
                    <span id="dash-exp-count" class="text-3xl font-black text-amber-600">0</span>
                </div>
                <h3 class="text-lg font-bold text-slate-700">تنبيهات الصلاحية</h3>
                <p class="text-xs text-slate-400 mt-1">متابعة التواريخ والدفعات</p>
            </div>

            <div onclick="switchView('notes')" class="group cursor-pointer bg-white p-6 rounded-3xl shadow-glass border border-slate-200 hover:border-emerald-500 hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1">
                 <div class="flex justify-between items-start mb-4">
                    <div class="w-12 h-12 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center text-2xl group-hover:scale-110 transition">
                        <i class="fa-solid fa-book-open"></i>
                    </div>
                    <span id="dash-notes-count" class="text-3xl font-black text-slate-800">0</span>
                </div>
                <h3 class="text-lg font-bold text-slate-700">دليل القهوة</h3>
                <p class="text-xs text-slate-400 mt-1">الوصفات والإيحاءات</p>
            </div>

            <div onclick="switchView('orders')" class="group cursor-pointer bg-white p-6 rounded-3xl shadow-glass border border-slate-200 hover:border-purple-500 hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1">
                 <div class="flex justify-between items-start mb-4">
                    <div class="w-12 h-12 rounded-2xl bg-purple-50 text-purple-600 flex items-center justify-center text-2xl group-hover:scale-110 transition">
                        <i class="fa-solid fa-dolly"></i>
                    </div>
                    <span id="dash-orders-count" class="text-3xl font-black text-purple-600">0</span>
                </div>
                <h3 class="text-lg font-bold text-slate-700">طلبات قيد الانتظار</h3>
                <p class="text-xs text-slate-400 mt-1">تشمل المعرض والكافيه</p>
            </div>
        </div>
        
        <div class="mt-12 w-full max-w-5xl flex flex-col items-center">
            <div class="flex gap-4 mb-4">
                 <button onclick="document.getElementById('fileInputGlobal').click()" class="px-6 py-3 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700 transition flex items-center gap-2 shadow-lg shadow-brand-500/30 btn-pulse">
                    <i class="fa-solid fa-file-import"></i> استيراد (الجرد فقط)
                </button>
                <input type="file" id="fileInputGlobal" class="hidden" accept=".xlsx,.xls" onchange="handleGlobalImport(event)">
                
                <button onclick="exportGlobalData()" class="px-6 py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 transition flex items-center gap-2 shadow-lg shadow-slate-500/30 btn-pulse">
                    <i class="fa-solid fa-file-export"></i> تصدير (التقرير الشامل)
                </button>
            </div>

            <div onclick="switchView('tracking')" class="group cursor-pointer bg-white p-6 rounded-3xl shadow-glass border border-slate-200 hover:border-green-500 hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1">
                 <div class="flex justify-between items-start mb-4">
                    <div class="w-12 h-12 rounded-2xl bg-green-50 text-green-600 flex items-center justify-center text-2xl group-hover:scale-110 transition">
                        <i class="fa-solid fa-truck-fast"></i>
                    </div>
                    <span id="dash-track-count" class="text-3xl font-black text-slate-800">0</span>
                </div>
                <h3 class="text-lg font-bold text-slate-700">تتبع الشحنات</h3>
                <p class="text-xs text-slate-400 mt-1">بوليصات الشحن والطلبات</p>
            </div>
        </div>
             <div class="mt-12 w-full max-w-5xl flex flex-col items-center">
            <button onclick="clearAllData()" class="px-6 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition flex items-center gap-2 shadow-lg shadow-red-500/30 btn-pulse mt-8">
                <i class="fa-solid fa-skull-crossbones"></i> حذف جميع بيانات التطبيق
            </button>
        </div>
    </div>

    <!-- VIEW: ORDERS -->
    <div id="view-orders" class="absolute inset-0 flex hidden bg-slate-100">
        <aside class="w-full lg:w-[380px] bg-white border-l border-slate-200 flex flex-col z-20 shadow-xl overflow-y-auto no-print">
            <div class="p-5 bg-purple-50 border-b border-purple-100">
                <h3 class="text-lg font-black text-purple-900 flex items-center gap-2">
                    <i class="fa-solid fa-cart-plus"></i> <span id="order-form-title">إضافة طلب جديد</span>
                </h3>
            </div>

            <div class="p-5 flex flex-col gap-4">
                <div class="bg-slate-100 p-1 rounded-xl flex">
                    <button onclick="setOrderSource('showroom')" id="btn-src-showroom" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all shadow-sm bg-white text-showroom-600">
                        <i class="fa-solid fa-store"></i> المعرض
                    </button>
                    <button onclick="setOrderSource('cafe')" id="btn-src-cafe" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all text-slate-500 hover:text-cafe-600">
                        <i class="fa-solid fa-mug-saucer"></i> الكافيه
                    </button>
                </div>

                <div>
                    <label class="text-[11px] font-bold text-slate-500 mb-1 block">رقم الطلب</label>
                    <input id="ord-num" type="text" placeholder="مثلاً: PO-2024-001" class="w-full h-10 rounded-lg border border-slate-200 px-3 text-sm focus:border-purple-500 outline-none">
                </div>

                <div>
                    <label class="text-[11px] font-bold text-slate-500 mb-1 block">اسم المحمصة أو الشركة</label>
                    <input id="ord-company" type="text" placeholder="اسم المورد..." class="w-full h-10 rounded-lg border border-slate-200 px-3 text-sm focus:border-purple-500 outline-none">
                </div>

                <div>
                    <label class="text-[11px] font-bold text-slate-500 mb-1 block">نوع الطلب</label>
                    <select id="ord-type" class="w-full h-10 rounded-lg border border-slate-200 px-3 text-sm focus:border-purple-500 outline-none bg-white">
                        <option value="أمر شراء">أمر شراء</option>
                        <option value="طلب مواد">طلب مواد</option>
                        <option value="طلب تحويل بين الفروع">طلب تحويل بين الفروع</option>
                        <option value="مستودع بضاعة في الطريق">مستودع بضاعة في الطريق</option>
                    </select>
                </div>

                <div>
                    <label class="text-[11px] font-bold text-slate-500 mb-1 block">تاريخ الطلب</label>
                    <input id="ord-date" type="date" class="w-full h-10 rounded-lg border border-slate-200 px-3 text-sm focus:border-purple-500 outline-none">
                </div>
                
                <div>
                    <label class="text-[11px] font-bold text-slate-500 mb-1 block">ملاحظات إضافية</label>
                    <textarea id="ord-notes" placeholder="أي تفاصيل إضافية..." class="w-full h-16 rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-purple-500 outline-none resize-none"></textarea>
                </div>

                <input type="hidden" id="ord-edit-id" value="">
                
                <button onclick="saveOrder()" class="w-full h-12 bg-purple-600 hover:bg-purple-500 text-white rounded-xl font-bold shadow-lg shadow-purple-600/20 transition btn-pulse mt-2">
                    <i class="fa-solid fa-save"></i> <span id="order-save-btn-text">تسجيل الطلب</span>
                </button>
                
                <button onclick="cancelOrderEdit()" id="cancel-edit-btn" class="hidden w-full h-10 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-xl font-bold transition">
                    <i class="fa-solid fa-times"></i> إلغاء التعديل
                </button>
                
                <button onclick="clearPageData('orders')" class="w-full h-10 bg-red-100 hover:bg-red-200 text-red-600 rounded-xl font-bold transition btn-pulse mt-4">
                    <i class="fa-solid fa-trash-alt"></i> حذف بيانات الطلبات
                </button>
            </div>
        </aside>

        <main class="flex-1 overflow-hidden flex flex-col p-4 bg-slate-100">
            <div class="flex gap-4 mb-4 no-print">
                <button onclick="switchOrdersTab('showroom')" id="tab-showroom" class="flex-1 py-3 bg-white rounded-xl shadow-sm border-2 border-transparent text-showroom-600 font-bold transition-all relative overflow-hidden group">
                    <span class="relative z-10 flex items-center justify-center gap-2"><i class="fa-solid fa-store"></i> طلبات المعرض</span>
                </button>
                <button onclick="switchOrdersTab('cafe')" id="tab-cafe" class="flex-1 py-3 bg-white rounded-xl shadow-sm border-2 border-transparent text-slate-400 font-bold transition-all relative overflow-hidden group">
                    <span class="relative z-10 flex items-center justify-center gap-2"><i class="fa-solid fa-mug-saucer"></i> طلبات الكافيه</span>
                </button>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex-1 overflow-hidden flex flex-col">
                <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center no-print">
                    <h3 id="orders-list-title" class="font-bold text-slate-700">قائمة الطلبات الجارية</h3>
                    <div class="flex gap-2 items-center">
                        <button onclick="window.print()" class="text-xs bg-slate-800 text-white px-3 py-1.5 rounded-lg hover:bg-slate-700"><i class="fa-solid fa-print"></i> طباعة</button>
                    </div>
                </div>
                <div class="table-container flex-1 p-4">
                    <table class="w-full text-right text-xs sm:text-sm border-collapse">
                        <thead class="bg-slate-50 text-slate-500 font-bold">
                            <tr>
                                <th class="p-3 w-16">الحالة</th>
                                <th class="p-3 w-32">رقم الطلب</th>
                                <th class="p-3 w-32">الجهة / المحمصة</th>
                                <th class="p-3 w-28">نوع الطلب</th>
                                <th class="p-3">ملاحظات</th>
                                <th class="p-3 text-center w-28">تاريخ الطلب</th>
                                <th class="p-3 text-center w-24">المدة</th>
                                <th class="p-3 text-center w-24 no-print">إجراء</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                    <div id="orders-empty" class="hidden flex flex-col items-center justify-center text-slate-300 py-10">
                        <i class="fa-solid fa-folder-open text-4xl mb-3"></i>
                        <p class="text-sm">لا توجد طلبات مسجلة في هذا القسم</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- VIEW: INVENTORY (الجرد) -->
    <div id="view-inventory" class="absolute inset-0 flex hidden bg-slate-100">
        <aside class="w-full lg:w-[400px] bg-white border-l border-slate-200 flex flex-col z-20 shadow-xl no-print">
            <div class="p-5 bg-slate-50 border-b border-slate-200">
                <h3 class="text-sm font-black text-brand-900 mb-2">إدارة الجرد</h3>
                <div class="relative">
                    <input id="inv-search" type="text" placeholder="باركود أو اسم..." class="w-full h-12 rounded-xl border-2 border-slate-200 px-10 text-sm font-bold focus:border-brand-500 outline-none transition" oninput="handleInventorySearch(this.value)">
                    <i class="fa-solid fa-barcode absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                </div>
                <ul id="inv-results" class="hidden mt-2 bg-white rounded-xl shadow-lg border border-slate-100 max-h-40 overflow-y-auto z-50 absolute w-[90%] left-5"></ul>
                
                <div class="flex gap-2 mt-3">
                    <button onclick="document.getElementById('fileInputInv').click()" class="flex-1 py-2 bg-white border border-slate-200 rounded-lg text-[10px] font-bold text-slate-600 hover:bg-slate-50">
                        <i class="fa-solid fa-upload text-brand-500"></i> استيراد
                    </button>
                    <input type="file" id="fileInputInv" class="hidden" accept=".xlsx,.xls" onchange="handleInventoryImport(event)">
                    <button onclick="exportInventoryData()" class="flex-1 py-2 bg-white border border-slate-200 rounded-lg text-[10px] font-bold text-slate-600 hover:bg-slate-50">
                        <i class="fa-solid fa-download text-brand-500"></i> تصدير
                    </button>
                </div>

                <!-- زر حذف بيانات الجرد -->
                <button onclick="clearPageData('inventory')" class="w-full py-2 bg-red-100 border border-red-200 rounded-lg text-xs font-bold text-red-600 hover:bg-red-50 mt-3 transition btn-pulse">
                    <i class="fa-solid fa-trash-alt"></i> تصفير كميات الجرد فقط
                </button>
            </div>

            <div id="inv-card" class="hidden flex-1 p-5 flex flex-col gap-4 overflow-y-auto">
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 text-center relative group">
                    <h2 id="inv-name" class="text-lg font-black text-brand-900 mb-1">اسم الصنف</h2>
                    <span id="inv-code" class="text-xs font-mono text-slate-500 bg-white px-2 py-1 rounded border">CODE</span>
                    
                    <button onclick="deleteCurrentItem()" class="absolute top-2 left-2 text-red-400 hover:text-red-600 bg-white p-2 rounded-lg shadow-sm border border-red-100 transition" title="حذف الصنف نهائياً">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white p-3 rounded-xl border border-slate-100 text-center shadow-sm">
                        <span class="text-[10px] text-slate-400 block mb-1">الكمية الحالية</span>
                        <span id="inv-current-qty" class="text-2xl font-black text-slate-700">0</span>
                    </div>
                     <div class="bg-white p-3 rounded-xl border border-slate-100 text-center shadow-sm">
                        <span class="text-[10px] text-slate-400 block mb-1">الكمية بالنظام</span>
                        <span id="inv-sys-qty" class="text-2xl font-black text-slate-400">0</span>
                    </div>
                </div>

                <div class="mt-auto bg-white p-4 rounded-2xl shadow-glass border border-slate-200">
                    <div class="flex gap-2 mb-3">
                        <button onclick="setInvMode('add')" id="btn-inv-add" class="flex-1 py-2 rounded-lg text-xs font-bold bg-brand-600 text-white transition-colors">إضافة (+)</button>
                        <button onclick="setInvMode('sub')" id="btn-inv-sub" class="flex-1 py-2 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 transition-colors">خصم (-)</button>
                    </div>
                    <input id="inv-input-qty" type="number" class="w-full h-12 text-center text-xl font-bold border-2 border-slate-200 rounded-xl mb-3 focus:border-brand-500 outline-none" placeholder="الكمية">
                    <button onclick="submitInventory()" class="w-full h-12 bg-brand-900 text-white rounded-xl font-bold hover:bg-brand-800 transition btn-pulse">تأكيد العملية</button>
                </div>
            </div>
            
            <div id="inv-empty" class="flex-1 flex flex-col items-center justify-center text-slate-300">
                <i class="fa-solid fa-barcode text-4xl mb-3"></i>
                <p class="text-sm">امسح الكود للبدء</p>
            </div>
        </aside>

        <main class="flex-1 overflow-hidden flex flex-col p-4">
             <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex-1 overflow-hidden flex flex-col">
                <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center no-print">
                    <h3 class="font-bold text-brand-900">سجل الجرد</h3>
                    <button onclick="window.print()" class="text-xs bg-slate-800 text-white px-3 py-1.5 rounded-lg hover:bg-slate-700"><i class="fa-solid fa-print"></i> طباعة</button>
                </div>
                <div class="table-container flex-1">
                    <table class="w-full text-right text-xs sm:text-sm border-collapse table-auto">
                        <thead class="bg-slate-50 text-slate-500 font-bold sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="p-3 w-32">الكود</th>
                                <th class="p-3">الصنف</th>
                                <th class="p-3 text-center w-24">النظام</th>
                                <th class="p-3 text-center w-24 bg-blue-50 text-blue-800">الفعلي</th>
                                <th class="p-3 text-center w-24">الفارق</th>
                            </tr>
                        </thead>
                        <tbody id="inv-table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
             </div>
        </main>
    </div>

    <!-- VIEW: EXPIRY (الصلاحية) -->
    <div id="view-expiry" class="absolute inset-0 flex hidden bg-slate-100">
        <aside class="w-full lg:w-[420px] bg-white border-l border-slate-200 flex flex-col z-20 shadow-xl no-print">
             <div class="p-5 bg-amber-50 border-b border-amber-100">
                <h3 class="text-sm font-black text-amber-900 mb-2">إدارة التواريخ</h3>
                <div class="relative">
                    <input id="exp-search" type="text" placeholder="بحث عن صنف..." class="w-full h-12 rounded-xl border-2 border-amber-200 px-10 text-sm font-bold focus:border-amber-500 outline-none transition bg-white" onkeyup="handleSearch('expiry', this.value)">
                    <i class="fa-solid fa-magnifying-glass absolute right-3 top-1/2 -translate-y-1/2 text-amber-400"></i>
                </div>
                <ul id="exp-results" class="hidden mt-2 bg-white rounded-xl shadow-lg border border-slate-100 max-h-40 overflow-y-auto z-50 absolute w-[90%] left-5"></ul>
                
                <div class="flex gap-2 mt-3">
                    <button onclick="document.getElementById('fileInputExp').click()" class="flex-1 py-2 bg-white border border-amber-200 rounded-lg text-[10px] font-bold text-amber-700 hover:bg-amber-50">
                        <i class="fa-solid fa-upload"></i> استيراد
                    </button>
                    <input type="file" id="fileInputExp" class="hidden" accept=".xlsx,.xls" onchange="handleExpiryImport(event)">
                    <button onclick="exportExpiryData()" class="flex-1 py-2 bg-white border border-amber-200 rounded-lg text-[10px] font-bold text-amber-700 hover:bg-amber-50">
                        <i class="fa-solid fa-download"></i> تصدير
                    </button>
                </div>
                
                <button onclick="clearPageData('expiry')" class="w-full py-2 bg-red-100 border border-red-200 rounded-lg text-xs font-bold text-red-600 hover:bg-red-50 mt-3">
                    <i class="fa-solid fa-trash-alt"></i> حذف سجل التواريخ فقط
                </button>
            </div>

            <div id="exp-card" class="hidden flex-1 p-5 flex flex-col gap-4 overflow-y-auto">
                <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                    <h2 id="exp-name" class="text-lg font-black text-slate-800">اسم الصنف</h2>
                    <p class="text-xs text-slate-400 mt-1">إدارة الدفعات والتواريخ</p>
                </div>

                <div class="bg-amber-50 p-4 rounded-2xl border border-amber-100 space-y-3">
                    <div>
                        <label class="text-[11px] font-bold text-amber-800 mb-1 block">تاريخ التحميص (اليوم-الشهر-السنة)</label>
                        <input id="exp-date" type="date" class="w-full h-10 rounded-lg border border-amber-200 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500/20">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-amber-800 mb-1 block">مدة الصلاحية (أشهر)</label>
                        <input id="exp-duration" type="number" value="12" class="w-full h-10 rounded-lg border border-amber-200 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500/20">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-amber-800 mb-1 block">الكمية لهذه الدفعة</label>
                        <input id="exp-qty" type="number" placeholder="مثلاً: 12" class="w-full h-10 rounded-lg border border-amber-200 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500/20">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="addBatch()" id="btn-add-batch" class="flex-1 h-10 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-bold text-sm transition mt-2 btn-pulse">
                            <i class="fa-solid fa-plus"></i> إضافة التاريخ
                        </button>
                         <button onclick="cancelBatchEdit()" id="btn-cancel-batch" class="hidden flex-1 h-10 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg font-bold text-sm transition mt-2">
                            إلغاء
                        </button>
                    </div>
                </div>

                <div class="flex-1">
                    <h4 class="text-xs font-bold text-slate-500 mb-2">الدفعات والتواريخ المسجلة:</h4>
                    <div id="exp-batches-list" class="space-y-2"></div>
                </div>
            </div>
             <div id="exp-empty" class="flex-1 flex flex-col items-center justify-center text-slate-300">
                <i class="fa-solid fa-calendar-days text-4xl mb-3"></i>
                <p class="text-sm">اختر صنفاً لإدارة تواريخه</p>
            </div>
        </aside>

        <main class="flex-1 overflow-hidden p-4">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 h-full flex flex-col">
                 <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center no-print">
                     <h3 class="font-bold text-slate-700">تقرير الصلاحية التفصيلي</h3>
                     <button onclick="window.print()" class="text-xs bg-slate-800 text-white px-3 py-1.5 rounded-lg hover:bg-slate-700"><i class="fa-solid fa-print"></i> طباعة</button>
                 </div>
                 <div class="table-container flex-1">
                     <table class="w-full text-right text-xs sm:text-sm border-collapse table-auto">
                         <thead class="bg-slate-50 text-slate-500 font-bold sticky top-0 z-10 shadow-sm">
                             <tr>
                                 <th class="p-3 w-32">الكود</th>
                                 <th class="p-3">الصنف</th>
                                 <th class="p-3 text-center w-32">تاريخ التحميص</th>
                                 <th class="p-3 text-center w-32">تاريخ الانتهاء</th>
                                 <th class="p-3 text-center w-24">الكمية</th>
                                 <th class="p-3 text-center w-32">الحالة</th>
                             </tr>
                         </thead>
                         <tbody id="exp-table-body" class="divide-y divide-slate-100"></tbody>
                     </table>
                 </div>
            </div>
        </main>
    </div>

    <!-- VIEW: NOTES (الملاحظات) -->
    <div id="view-notes" class="absolute inset-0 flex hidden bg-slate-100">
        <aside class="w-full lg:w-[400px] bg-white border-l border-slate-200 flex flex-col z-20 shadow-xl no-print">
             <div class="p-5 bg-emerald-50 border-b border-emerald-100">
                <h3 class="text-sm font-black text-emerald-900 mb-2">سجل الإيحاءات</h3>
                <div class="relative">
                    <input id="note-search" type="text" placeholder="ابحث بالإيحاء..." class="w-full h-12 rounded-xl border-2 border-emerald-200 px-10 text-sm font-bold focus:border-emerald-500 outline-none transition bg-white" onkeyup="handleSearch('notes', this.value)">
                    <i class="fa-solid fa-mug-hot absolute right-3 top-1/2 -translate-y-1/2 text-emerald-400"></i>
                </div>
                <ul id="note-results" class="hidden mt-2 bg-white rounded-xl shadow-lg border border-slate-100 max-h-40 overflow-y-auto z-50 absolute w-[90%] left-5"></ul>
                
                <div class="flex gap-2 mt-3">
                    <button onclick="document.getElementById('fileInputNotes').click()" class="flex-1 py-2 bg-white border border-emerald-200 rounded-lg text-[10px] font-bold text-emerald-700 hover:bg-emerald-50">
                        <i class="fa-solid fa-upload"></i> استيراد
                    </button>
                    <input type="file" id="fileInputNotes" class="hidden" accept=".xlsx,.xls" onchange="handleNotesImport(event)">
                    <button onclick="exportNotesData()" class="flex-1 py-2 bg-white border border-emerald-200 rounded-lg text-[10px] font-bold text-emerald-700 hover:bg-emerald-50">
                        <i class="fa-solid fa-download"></i> تصدير
                    </button>
                </div>

                <!-- زر حذف بيانات الإيحاءات -->
                <button onclick="clearPageData('notes')" class="w-full py-2 bg-red-100 border border-red-200 rounded-lg text-xs font-bold text-red-600 hover:bg-red-50 mt-3 transition btn-pulse">
                    <i class="fa-solid fa-trash-alt"></i> تصفير سجل الإيحاءات فقط
                </button>
            </div>

            <div id="note-card" class="hidden flex-1 p-5 flex flex-col gap-4 overflow-y-auto">
                 <div class="bg-white p-4 rounded-2xl border border-slate-200 text-center">
                    <h2 id="note-name" class="text-lg font-black text-emerald-900 mb-1">اسم القهوة</h2>
                    <span id="note-code" class="text-xs font-mono text-slate-400">CODE</span>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">اسم المحمصة</label>
                        <div class="relative">
                            <i class="fa-solid fa-fire-burner absolute right-3 top-1/2 -translate-y-1/2 text-slate-300"></i>
                            <input id="note-roastery" type="text" class="w-full h-10 rounded-xl border border-slate-200 pr-9 pl-3 text-sm focus:border-emerald-500 outline-none" placeholder="مثلاً: محمصة الرياض">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">الإيحاءات / الملاحظات</label>
                        <textarea id="note-text" class="w-full h-32 rounded-xl border border-slate-200 p-3 text-sm focus:border-emerald-500 outline-none resize-none leading-relaxed" placeholder="أدخل الإيحاءات هنا..."></textarea>
                    </div>

                    <button onclick="saveNote()" class="w-full h-12 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold shadow-lg shadow-emerald-600/20 transition btn-pulse">
                        حفظ التعديلات
                    </button>
                </div>
            </div>

             <div id="note-empty" class="flex-1 flex flex-col items-center justify-center text-slate-300">
                <i class="fa-solid fa-pen-nib text-4xl mb-3"></i>
                <p class="text-sm">اختر صنفاً لتعديل بياناته</p>
            </div>
        </aside>

        <main class="flex-1 overflow-hidden p-4">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 h-full flex flex-col">
                 <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center no-print">
                     <h3 class="font-bold text-slate-700">دليل القهوة</h3>
                     <button onclick="window.print()" class="text-xs bg-slate-800 text-white px-3 py-1.5 rounded-lg hover:bg-slate-700"><i class="fa-solid fa-print"></i> طباعة</button>
                 </div>
                 <div class="table-container flex-1">
                     <table class="w-full text-right text-xs sm:text-sm border-collapse table-auto">
                         <thead class="bg-slate-50 text-slate-500 font-bold sticky top-0 z-10 shadow-sm">
                             <tr>
                                 <th class="p-3 w-24">الكود</th>
                                 <th class="p-3 w-48">الصنف</th>
                                 <th class="p-3 w-40">المحمصة</th>
                                 <th class="p-3">الإيحاءات / الملاحظات</th>
                             </tr>
                         </thead>
                         <tbody id="note-table-body" class="divide-y divide-slate-100"></tbody>
                     </table>
                 </div>
            </div>
        </main>
    </div>


    <!-- ======== VIEW: TRACKING ======== -->
    <div id="view-tracking" class="absolute inset-0 hidden p-4 sm:p-6 overflow-y-auto fade-in">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4">
                <div>
                    <h2 class="text-2xl sm:text-3xl font-black text-brand-900">تتبع بوليصات الشحن</h2>
                    <p class="text-sm text-slate-500 mt-1">إدارة ومتابعة شحنات الطلبات</p>
                </div>
                <button onclick="exportTrackingExcel()" class="bg-success-600 hover:bg-success-700 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-lg btn-pulse flex items-center gap-2">
                    <i class="fa-solid fa-file-excel"></i>
                    <span>تصدير Excel</span>
                </button>
            </div>

            <div class="glass-panel p-4 sm:p-6 rounded-2xl shadow-lg mb-6">
                <h3 class="text-lg font-bold text-brand-800 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-plus-circle"></i>
                    إضافة / تعديل بوليصة شحن
                </h3>
                <form id="trackingForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">رقم أمر الشراء/الطلب</label>
                        <input type="text" id="track-order-id" placeholder="مثال: PO-2024-001" class="w-full p-3 rounded-xl border border-slate-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 transition text-sm" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">رقم بوليصة الشحن/الفاتورة</label>
                        <input type="text" id="track-shipment-number" placeholder="مثال: INV-SHP-12345" class="w-full p-3 rounded-xl border border-slate-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 transition text-sm" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">حالة الشحنة</label>
                        <select id="track-status" class="w-full p-3 rounded-xl border border-slate-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 transition text-sm">
                            <option value="تم التحضير">تم التحضير للشحن</option>
                            <option value="في المستودع">الشحنة في المستودع</option>
                            <option value="في الطريق">الشحنة في الطريق</option>
                            <option value="وصلت المستودع">وصلت للمستودع المقابل</option>
                            <option value="تم الاستلام">تم استلام الشحنة كاملة</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">ملاحظات إضافية</label>
                        <input type="text" id="track-notes" placeholder="مثال: تأخير بسبب الطقس (اختياري)" class="w-full p-3 rounded-xl border border-slate-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 transition text-sm">
                    </div>
                    <div class="flex items-end">
                        <label class="w-full px-4 py-3 rounded-xl border border-slate-300 bg-slate-50 flex items-center gap-2 cursor-pointer hover:bg-slate-100 transition">
                            <input type="checkbox" id="track-delivered" class="accent-brand-600 w-4 h-4">
                            <span class="text-sm font-bold text-slate-700">✅ تم استلام الشحنة بالكامل</span>
                        </label>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-brand-600 hover:bg-brand-700 text-white py-3 px-4 rounded-xl font-bold shadow-lg btn-pulse flex items-center justify-center gap-2">
                            <i class="fa-solid fa-save"></i>
                            <span id="tracking-submit-text">حفظ بيانات الشحنة</span>
                        </button>
                        <button type="button" onclick="resetTrackingForm()" class="px-4 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-xl font-bold btn-pulse" title="تنظيف النموذج">
                            <i class="fa-solid fa-rotate-left"></i> إعادة تعيين
                        </button>
                    </div>
                </form>
            </div>

            <div class="glass-panel p-4 sm:p-6 rounded-2xl shadow-lg">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3">
                    <h3 class="text-lg font-bold text-brand-800 flex items-center gap-2">
                        <i class="fa-solid fa-list"></i>
                        قائمة الشحنات المحفوظة
                    </h3>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="filterTracking('all')" id="filter-all" class="filter-btn px-3 py-1 rounded-lg text-xs font-bold bg-brand-600 text-white">
                            الكل <span class="ml-1">(<span id="count-all">0</span>)</span>
                        </button>
                        <button onclick="filterTracking('pending')" id="filter-pending" class="filter-btn px-3 py-1 rounded-lg text-xs font-bold bg-slate-100 text-slate-600">
                            قيد الشحن <span class="ml-1">(<span id="count-pending">0</span>)</span>
                        </button>
                        <button onclick="filterTracking('delivered')" id="filter-delivered" class="filter-btn px-3 py-1 rounded-lg text-xs font-bold bg-slate-100 text-slate-600">
                            وصلت بنجاح <span class="ml-1">(<span id="count-delivered">0</span>)</span>
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-xl border border-slate-200" style="max-height: 60vh;">
                    <table class="w-full text-xs sm:text-sm border-collapse">
                        <thead class="bg-gradient-to-r from-brand-50 to-purple-50 text-brand-900 font-bold sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="p-3 text-right whitespace-nowrap">رقم أمر الشراء</th>
                                <th class="p-3 text-right whitespace-nowrap">رقم الفاتورة/البوليصة</th>
                                <th class="p-3 text-center whitespace-nowrap">حالة الشحنة</th>
                                <th class="p-3 text-center whitespace-nowrap">تم الاستلام</th>
                                <th class="p-3 text-right wrap-text">ملاحظات</th>
                                <th class="p-3 text-center whitespace-nowrap">آخر تحديث</th>
                                <th class="p-3 text-center whitespace-nowrap no-print">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="tracking-table-body"></tbody>
                    </table>
                </div>
                <div id="tracking-empty" class="text-center py-12 hidden">
                    <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-slate-100 flex items-center justify-center">
                        <i class="fa-solid fa-truck-fast text-3xl text-slate-400"></i>
                    </div>
                    <p class="text-slate-500 font-bold text-lg">لا توجد شحنات مسجلة حالياً</p>
                    <p class="text-xs text-slate-400 mt-2">ابدأ بإضافة بيانات شحنة جديدة من النموذج في الأعلى</p>
                    <p class="text-xs text-slate-300 mt-3">تعليمات: أدخل أرقام الطلبات والفواتير، حدد الحالة، وانقر حفظ لحفظ البيانات</p>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Print Footer -->
<div class="print-footer hidden">
    <p>تطوير: أحمد الطيب - 0550360705</p>
</div>

<div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl font-bold text-sm opacity-0 pointer-events-none transition-all duration-300 z-[100]">
    تمت العملية بنجاح
</div>

<div id="addItemModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] hidden items-center justify-center fade-in">
    <div class="bg-white p-6 rounded-2xl w-96 max-w-[90%] shadow-2xl">
        <h3 class="text-lg font-bold mb-4">إضافة صنف جديد للنظام</h3>
        <input id="new-code" readonly class="w-full mb-2 bg-slate-100 p-2 rounded text-xs font-mono text-slate-500">
        <input id="new-name" placeholder="اسم الصنف" class="w-full mb-2 border p-2 rounded">
        <input id="new-sys-qty" type="number" placeholder="الكمية الافتراضية" class="w-full mb-4 border p-2 rounded">
        <div class="flex gap-2">
            <button onclick="confirmAddItem()" class="flex-1 bg-brand-600 text-white py-2 rounded-lg font-bold">حفظ</button>
            <button onclick="document.getElementById('addItemModal').classList.add('hidden')" class="flex-1 bg-slate-100 text-slate-600 py-2 rounded-lg font-bold">إلغاء</button>
        </div>
    </div>
</div>

<script>
    const STORAGE_KEY_INV = 'ims_inventory_data_v2';
    const STORAGE_KEY_ORDERS = 'ims_orders_data_v2';
    
    let inventory = [];
    let ordersData = { showroom: [], cafe: [] };
    let currentView = 'home';
    let selectedItemIdx = -1;
    let invMode = 'add'; 
    let activeOrderSource = 'showroom';
    let activeOrdersTab = 'showroom';
    let editingOrderId = null;
    let editingBatchId = null;

    function init() {
        loadTracking();
        renderTrackingTable();
        updateTrackingCounts();
        const data = localStorage.getItem(STORAGE_KEY_INV);
        if (data) {
            try {
                inventory = JSON.parse(data);
            } catch(e) {
                console.error("Error parsing inventory", e);
                inventory = [];
            }
        }
        
        // Ensure data integrity
        if (!Array.isArray(inventory)) inventory = [];
        inventory.forEach(item => {
            if (!item.batches) item.batches = [];
            if (!item.roastery) item.roastery = "";
            if (!item.notes) item.notes = "";
        });

        const ordData = localStorage.getItem(STORAGE_KEY_ORDERS);
        if (ordData) {
            try {
                ordersData = JSON.parse(ordData);
            } catch(e) {
                ordersData = { showroom: [], cafe: [] };
            }
        }
        if(!ordersData.showroom) ordersData.showroom = [];
        if(!ordersData.cafe) ordersData.cafe = [];
        
        ['showroom', 'cafe'].forEach(key => {
            ordersData[key].forEach(o => {
                if(!o.status) o.status = 'pending';
                if(!o.notes) o.notes = "";
            });
        });

        updateDashboardStats();
        switchView('home');

        document.getElementById('inv-input-qty').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') submitInventory();
        });
        
        document.getElementById('ord-date').valueAsDate = new Date();
    }

    function updateDashboardStats() {
        document.getElementById('dash-inv-count').innerText = inventory.length;

        let expAlerts = 0;
        inventory.forEach(item => {
            if(item.batches && item.batches.length > 0) {
                item.batches.forEach(b => {
                     const { remainingDays } = calcExpiry(b.date, b.duration);
                     if(remainingDays <= 30) expAlerts++;
                });
            }
        });
        document.getElementById('dash-exp-count').innerText = expAlerts;

        const notesCount = inventory.filter(i => i.notes && i.notes.length > 2).length;
        document.getElementById('dash-notes-count').innerText = notesCount;

        const pendingShowroom = ordersData.showroom.filter(o => o.status !== 'completed').length;
        const pendingCafe = ordersData.cafe.filter(o => o.status !== 'completed').length;
        document.getElementById('dash-orders-count').innerText = pendingShowroom + pendingCafe;
        
        const pendingTracking = trackingData.filter(t => !t.delivered).length;
        if(document.getElementById('dash-track-count')) document.getElementById('dash-track-count').innerText = pendingTracking;
    }

    function switchView(viewName) {
        currentView = viewName;
        ['view-home', 'view-inventory', 'view-expiry', 'view-notes', 'view-orders', 'view-tracking'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        
        document.getElementById(`view-${viewName}`).classList.remove('hidden');
        document.getElementById(`view-${viewName}`).classList.add('fade-in');

        selectedItemIdx = -1;
        
        // تحديث الترجمات للصفحة الجديدة
        updateAllUIText();
        
        if (viewName === 'inventory') {
            resetInvUI();
            renderInvTable();
            setTimeout(() => document.getElementById('inv-search').focus(), 100);
        } else if (viewName === 'expiry') {
            resetExpUI();
            renderExpTable();
        } else if (viewName === 'notes') {
            resetNoteUI();
            renderNoteTable();
        } else if (viewName === 'orders') {
            switchOrdersTab(activeOrdersTab);
            setOrderSource(activeOrderSource);
        } else if (viewName === 'tracking') {
            renderTrackingTable();
            updateTrackingCounts();
        } else if (viewName === 'home') {
            updateDashboardStats();
        }
    }

    function goToHome() {
        switchView('home');
    }

    // ========== LANGUAGE SYSTEM ==========
    let currentLanguage = localStorage.getItem('app-language') || 'ar';

    const translations = {
        ar: {
            appTitle: "نظام الإدارة المتكامل - تطوير أحمد الطيب",
            versionText: "نسخة محسنة V2.4",
            dashboard: "لوحة القيادة والمتابعة",
            overview: "نظرة عامة على حالة العمل",
            inventory: "الجرد العام",
            inventorySubtitle: "إدارة الكميات وحذف الأصناف",
            expiry: "تنبيهات الصلاحية",
            expirySubtitle: "متابعة التواريخ والدفعات",
            notes: "دليل القهوة",
            notesSubtitle: "الوصفات والإيحاءات",
            orders: "طلبات قيد الانتظار",
            ordersSubtitle: "تشمل المعرض والكافيه",
            tracking: "تتبع الشحنات",
            trackingSubtitle: "بوليصات الشحن والطلبات",
            saveChanges: "حفظ التغييرات",
            home: "الرئيسية",
            english: "English",
            importInventory: "استيراد (الجرد فقط)",
            exportReport: "تصدير (التقرير الشامل)",
            deleteAllData: "حذف جميع بيانات التطبيق",
            addOrder: "إضافة طلب جديد",
            orderNumber: "رقم الطلب",
            company: "اسم المحمصة أو الشركة",
            orderType: "نوع الطلب",
            orderDate: "تاريخ الطلب",
            additionalNotes: "ملاحظات إضافية",
            registerOrder: "تسجيل الطلب",
            ordersList: "قائمة الطلبات الجارية",
            print: "طباعة",
            noOrders: "لا توجد طلبات مسجلة في هذا القسم",
            inventoryManagement: "إدارة الجرد",
            barcode: "باركود أو اسم...",
            resetInventory: "تصفير كميات الجرد فقط",
            currentQuantity: "الكمية الحالية",
            systemQuantity: "الكمية بالنظام",
            add: "إضافة (+)",
            subtract: "خصم (-)",
            quantity: "الكمية",
            confirmOperation: "تأكيد العملية",
            inventoryRecord: "سجل الجرد",
            code: "الكود",
            item: "الصنف",
            system: "النظام",
            actual: "الفعلي",
            difference: "الفارق",
            expiryManagement: "إدارة التواريخ",
            search: "بحث عن صنف...",
            resetExpiryData: "حذف سجل التواريخ فقط",
            roastDate: "تاريخ التحميص (اليوم-الشهر-السنة)",
            expiryDuration: "مدة الصلاحية (أشهر)",
            batchQuantity: "الكمية لهذه الدفعة",
            addDate: "إضافة التاريخ",
            registeredDates: "الدفعات والتواريخ المسجلة:",
            expiryReport: "تقرير الصلاحية التفصيلي",
            roastingDate: "تاريخ التحميص",
            expiryDate: "تاريخ الانتهاء",
            status: "الحالة",
            coffeGuide: "دليل القهوة",
            searchCoffee: "ابحث بالإيحاء...",
            resetHints: "تصفير سجل الإيحاءات فقط",
            roastery: "اسم المحمصة",
            hints: "الإيحاءات / الملاحظات",
            saveChangesBtn: "حفظ التعديلات",
            coffeeGuide: "دليل القهوة",
            shipmentTracking: "تتبع بوليصات الشحن",
            manageShipments: "إدارة ومتابعة شحنات الطلبات",
            exportExcel: "تصدير Excel",
            addShipment: "إضافة / تعديل بوليصة شحن",
            orderIdField: "رقم أمر الشراء/الطلب",
            shipmentNumber: "رقم بوليصة الشحن/الفاتورة",
            shipmentStatus: "حالة الشحنة",
            prepared: "تم التحضير للشحن",
            inWarehouse: "الشحنة في المستودع",
            inTransit: "الشحنة في الطريق",
            arrivedWarehouse: "وصلت للمستودع المقابل",
            received: "تم استلام الشحنة كاملة",
            additionalRemarks: "ملاحظات إضافية",
            finalReceived: "✅ تم استلام الشحنة بالكامل",
            saveShipmentData: "حفظ بيانات الشحنة",
            resetForm: "إعادة تعيين",
            shipmentsList: "قائمة الشحنات المحفوظة",
            all: "الكل",
            pending: "قيد الشحن",
            delivered: "وصلت بنجاح",
            noShipments: "لا توجد شحنات مسجلة حالياً",
            startAddingShipment: "ابدأ بإضافة بيانات شحنة جديدة من النموذج في الأعلى",
            instructions: "تعليمات: أدخل أرقام الطلبات والفواتير، حدد الحالة، وانقر حفظ لحفظ البيانات",
            actions: "إجراءات",
            edit: "تعديل",
            delete: "حذف",
            lastUpdate: "آخر تحديث",
            purchaseOrder: "رقم أمر الشراء",
            invoiceNumber: "رقم الفاتورة/البوليصة",
            hasReceived: "تم الاستلام",
            remarks: "ملاحظات",
            registrationOrder: "تسجيل الطلب",
            cancel: "إلغاء التعديل",
            deleteAllOrders: "حذف بيانات الطلبات",
            deleteCurrentItem: "حذف الصنف نهائياً",
            addQuantity: "إضافة (+)",
            subtractQuantity: "خصم (-)",
            addDate: "إضافة التاريخ",
            deleteHints: "حذف سجل الإيحاءات فقط",
            saveChangesBtn: "حفظ التعديلات",
            editOrder: "تعديل الطلب",
            addNewShipment: "إضافة / تعديل بوليصة شحن",
            // إضافات جديدة لجميع الخيارات والرسائل
            changeLang: "تغيير اللغة",
            pickOrder: "أمر شراء",
            materialRequest: "طلب مواد",
            transferRequest: "طلب تحويل بين الفروع",
            goodsInTransit: "مستودع بضاعة في الطريق",
            showroom: "المعرض",
            cafe: "الكافيه",
            selectItemToStart: "امسح الكود للبدء",
            selectItemToEdit: "اختر صنفاً لتعديل بياناته",
            selectItemToAddDate: "اختر صنفاً لإدارة تواريخه",
            coffeeNames: "أسماء القهوة",
            selectCoffeeToEdit: "اختر صنفاً لتعديل بياناته",
            noHints: "لا توجد ملاحظات",
            addNewItem: "إضافة صنف جديد",
            confirmAddNewItem: "إضافة صنف جديد للنظام",
            itemCode: "كود الصنف",
            itemName: "اسم الصنف",
            defaultQuantity: "الكمية الافتراضية",
            save: "حفظ",
            cancel: "إلغاء",
            roastery: "اسم المحمصة",
            enterHints: "أدخل الإيحاءات هنا...",
            exampleSupplier: "مثلاً: محمصة الرياض",
            orderNumberExample: "مثلاً: PO-2024-001",
            supplierNamePlaceholder: "اسم المورد...",
            additionalDetails: "أي تفاصيل إضافية...",
            updateOrder: "تم تحديث الطلب بنجاح",
            orderAdded: "تم إضافة الطلب بنجاح",
            deleteOrderConfirm: "هل أنت متأكد من حذف هذا الطلب نهائياً؟",
            orderDeleted: "تم حذف الطلب",
            fillAllFields: "يرجى ملء جميع الحقول",
            quantityUpdated: "تم تحديث الكمية",
            deleteItemConfirm: "هل أنت متأكد من حذف الصنف",
            permanentlyFrom: "نهائياً من النظام؟",
            itemDeletedSuccess: "تم حذف الصنف بنجاح",
            addDateSuccessful: "تم إضافة الدفعة",
            deleteAllOrdersConfirm: "هل أنت متأكد من حذف جميع بيانات الطلبات؟",
            allOrdersDeleted: "تم حذف بيانات الطلبات",
            deleteBatchConfirm: "حذف هذا التاريخ؟",
            batchDeleted: "تم حذف الدفعة",
            fillDateAndQuantity: "يرجى إدخال التاريخ والكمية",
            clearAllConfirm: "هل أنت متأكد تماماً من حذف جميع بيانات التطبيق بالكامل",
            cannotBeUndone: "لا يمكن التراجع عن هذا الإجراء!",
            allDataDeletedSuccess: "تم حذف جميع بيانات التطبيق بنجاح",
            orderModifying: "تم إنجاز الطلب",
            orderRestored: "تم إعادة الطلب لقائمة الانتظار",
            recordsNot: "لا توجد تواريخ",
            expired: "منتهي",
            daysRemaining: "يوم",
            monthsRemaining: "شهر",
            barakiData: "بيانات بوليصات الشحن",
            trackingTitle: "رقم أمر الشراء/الطلب",
            billNumber: "رقم بوليصة الشحن/الفاتورة",
            shipmentExample: "مثال: INV-SHP-12345",
            orderExample: "مثال: PO-2024-001",
            weatherDelay: "مثال: تأخير بسبب الطقس (اختياري)",
            fullReceipt: "✅ تم استلام الشحنة بالكامل",
            preparedForShip: "تم التحضير للشحن",
            warehouseStorage: "الشحنة في المستودع",
            inShipmentTransit: "الشحنة في الطريق",
            arrivedCounterpart: "وصلت للمستودع المقابل",
            fullyReceived: "تم استلام الشحنة كاملة",
            allShipments: "الكل",
            inTransitStatus: "قيد الشحن",
            successfullyReceived: "وصلت بنجاح",
            noShipmentsRecorded: "لا توجد شحنات مسجلة حالياً",
            startByAddingNew: "ابدأ بإضافة بيانات شحنة جديدة من النموذج في الأعلى",
            instructionsTrack: "تعليمات: أدخل أرقام الطلبات والفواتير، حدد الحالة، وانقر حفظ لحفظ البيانات",
            shipmentDataSaved: "تم حفظ بيانات الشحنة بنجاح",
            dataNotEmpty: "❌ لا توجد بيانات شحنات للتصدير",
            exportSuccess: "✅ تم تصدير البيانات بنجاح",
            formCleaned: "تم تنظيف النموذج",
            underModification: "🔄 قيد التعديل - غير البيانات ثم انقر الحفظ",
            updateShipment: "💾 تحديث بيانات الشحنة",
            deleteShipmentConfirm: "هل أنت متأكد من حذف الشحنة",
            shipmentDeleted: "🗑️ تم حذف الشحنة بنجاح",
            fillOrderAndShipment: "يرجى إدخال رقم الطلب ورقم البوليصة",
            shipmentAdded: "✅ تمت إضافة الشحنة بنجاح وحفظها",
            shipmentUpdated: "✅ تم تحديث بيانات الشحنة بنجاح",
            resetInventoryConfirm: "هل أنت متأكد من تصفير جميع الكميات الفعلية في صفحة الجرد؟",
            itemsNotDeleted: "(لن يتم حذف الأصناف، فقط تصفير الكميات)",
            inventoryCleared: "تم تصفير كميات الجرد",
            deleteAllExpiry: "هل أنت متأكد من حذف جميع تواريخ الصلاحية المسجلة؟",
            dateRecordDeleted: "تم حذف سجل التواريخ",
            deleteAllHints: "هل أنت متأكد من حذف جميع الإيحاءات والملاحظات؟",
            hintsRecordDeleted: "تم حذف سجل الإيحاءات",
            languageChanged: "تم تغيير اللغة إلى",
            arabic: "العربية 🇸🇦",
            englishLang: "English 🇬🇧",
            importedSuccessfully: "تم تحديث البيانات في جميع الصفحات",
            notesImported: "تم استيراد الإيحاءات والمحامص",
            expiryImported: "تم استيراد أصناف الصلاحية",
            inventoryImported: "تم استيراد بيانات الجرد",
            fileReadError: "خطأ في قراءة الملف",
            inventoryReport: "تقرير_الجرد",
            expiryReport: "تقرير_تواريخ_الانتهاء_المفصل",
            hintsReport: "تقرير_الإيحاءات",
            comprehensiveReport: "التقرير_الشامل_المفصل",
            shipmentsReport: "تتبع_شحنات",
            tableRowAction: "تم إنجاز الطلب"
        },
        en: {
            appTitle: "Integrated Management System - Development by Ahmed Al-Tayyib",
            versionText: "Enhanced Version V2.4",
            dashboard: "Dashboard and Monitoring",
            overview: "Overview of Work Status",
            inventory: "General Inventory",
            inventorySubtitle: "Manage quantities and delete items",
            expiry: "Expiry Alerts",
            expirySubtitle: "Track dates and batches",
            notes: "Coffee Guide",
            notesSubtitle: "Recipes and notes",
            orders: "Pending Orders",
            ordersSubtitle: "Showroom and Cafe",
            tracking: "Shipment Tracking",
            trackingSubtitle: "Bills of lading and orders",
            saveChanges: "Save Changes",
            home: "Home",
            english: "عربي",
            importInventory: "Import (Inventory Only)",
            exportReport: "Export (Comprehensive Report)",
            deleteAllData: "Delete All Application Data",
            addOrder: "Add New Order",
            orderNumber: "Order Number",
            company: "Roastery or Company Name",
            orderType: "Order Type",
            orderDate: "Order Date",
            additionalNotes: "Additional Notes",
            registerOrder: "Register Order",
            ordersList: "Current Orders List",
            print: "Print",
            noOrders: "No orders registered in this section",
            inventoryManagement: "Inventory Management",
            barcode: "Barcode or Name...",
            resetInventory: "Reset Inventory Quantities Only",
            currentQuantity: "Current Quantity",
            systemQuantity: "System Quantity",
            add: "Add (+)",
            subtract: "Subtract (-)",
            quantity: "Quantity",
            confirmOperation: "Confirm Operation",
            inventoryRecord: "Inventory Record",
            code: "Code",
            item: "Item",
            system: "System",
            actual: "Actual",
            difference: "Difference",
            expiryManagement: "Date Management",
            search: "Search for item...",
            resetExpiryData: "Delete Date Record Only",
            roastDate: "Roast Date (Day-Month-Year)",
            expiryDuration: "Expiry Duration (Months)",
            batchQuantity: "Quantity for This Batch",
            addDate: "Add Date",
            registeredDates: "Registered Batches and Dates:",
            expiryReport: "Detailed Expiry Report",
            roastingDate: "Roasting Date",
            expiryDate: "Expiry Date",
            status: "Status",
            coffeGuide: "Coffee Guide",
            searchCoffee: "Search by hint...",
            resetHints: "Reset Hints Record Only",
            roastery: "Roastery Name",
            hints: "Hints / Notes",
            saveChangesBtn: "Save Changes",
            coffeeGuide: "Coffee Guide",
            shipmentTracking: "Track Bills of Lading",
            manageShipments: "Manage and track shipments",
            exportExcel: "Export Excel",
            addShipment: "Add / Edit Shipment Bill",
            orderIdField: "Purchase Order Number",
            shipmentNumber: "Bill of Lading / Invoice Number",
            shipmentStatus: "Shipment Status",
            prepared: "Prepared for Shipment",
            inWarehouse: "Shipment in Warehouse",
            inTransit: "Shipment in Transit",
            arrivedWarehouse: "Arrived at Counterpart Warehouse",
            received: "Shipment Fully Received",
            additionalRemarks: "Additional Remarks",
            finalReceived: "✅ Shipment Fully Received",
            saveShipmentData: "Save Shipment Data",
            resetForm: "Reset",
            shipmentsList: "Saved Shipments List",
            all: "All",
            pending: "In Transit",
            delivered: "Successfully Received",
            noShipments: "No shipments registered currently",
            startAddingShipment: "Start by adding new shipment data from the form above",
            instructions: "Instructions: Enter order and invoice numbers, select status, and click save",
            actions: "Actions",
            edit: "Edit",
            delete: "Delete",
            lastUpdate: "Last Update",
            purchaseOrder: "Purchase Order Number",
            invoiceNumber: "Invoice/Bill Number",
            hasReceived: "Received",
            remarks: "Remarks",
            registrationOrder: "Register Order",
            cancel: "Cancel Modification",
            deleteAllOrders: "Delete Order Data",
            deleteCurrentItem: "Delete Item Permanently",
            addQuantity: "Add (+)",
            subtractQuantity: "Subtract (-)",
            addDate: "Add Date",
            deleteHints: "Reset Hints Record Only",
            saveChangesBtn: "Save Changes",
            editOrder: "Edit Order",
            addNewShipment: "Add / Edit Shipment Bill",
            changeLang: "Change Language",
            pickOrder: "Purchase Order",
            materialRequest: "Material Request",
            transferRequest: "Transfer Between Branches",
            goodsInTransit: "Goods in Transit Warehouse",
            showroom: "Showroom",
            cafe: "Cafe",
            selectItemToStart: "Scan code to start",
            selectItemToEdit: "Select item to edit data",
            selectItemToAddDate: "Select item to manage dates",
            coffeeNames: "Coffee Names",
            selectCoffeeToEdit: "Select item to edit data",
            noHints: "No notes",
            addNewItem: "Add new item",
            confirmAddNewItem: "Add new item to system",
            itemCode: "Item Code",
            itemName: "Item Name",
            defaultQuantity: "Default Quantity",
            save: "Save",
            cancel: "Cancel",
            roastery: "Roastery Name",
            enterHints: "Enter hints here...",
            exampleSupplier: "Example: Riyadh Roastery",
            orderNumberExample: "Example: PO-2024-001",
            supplierNamePlaceholder: "Supplier name...",
            additionalDetails: "Any additional details...",
            updateOrder: "Order updated successfully",
            orderAdded: "Order added successfully",
            deleteOrderConfirm: "Are you sure you want to delete this order permanently?",
            orderDeleted: "Order deleted",
            fillAllFields: "Please fill all fields",
            quantityUpdated: "Quantity updated",
            deleteItemConfirm: "Are you sure you want to delete item",
            permanentlyFrom: "permanently from the system?",
            itemDeletedSuccess: "Item deleted successfully",
            addDateSuccessful: "Batch added",
            deleteAllOrdersConfirm: "Are you sure you want to delete all order data?",
            allOrdersDeleted: "Order data deleted",
            deleteBatchConfirm: "Delete this date?",
            batchDeleted: "Batch deleted",
            fillDateAndQuantity: "Please enter date and quantity",
            clearAllConfirm: "Are you absolutely sure you want to delete all application data completely",
            cannotBeUndone: "This action cannot be undone!",
            allDataDeletedSuccess: "All application data deleted successfully",
            orderModifying: "Order completed",
            orderRestored: "Order restored to pending list",
            recordsNot: "No dates",
            expired: "Expired",
            daysRemaining: "day",
            monthsRemaining: "month",
            barakiData: "Bills of Lading Data",
            trackingTitle: "Purchase Order Number",
            billNumber: "Bill of Lading Number",
            shipmentExample: "Example: INV-SHP-12345",
            orderExample: "Example: PO-2024-001",
            weatherDelay: "Example: Delay due to weather (optional)",
            fullReceipt: "✅ Shipment Fully Received",
            preparedForShip: "Prepared for Shipment",
            warehouseStorage: "Shipment in Warehouse",
            inShipmentTransit: "Shipment in Transit",
            arrivedCounterpart: "Arrived at Counterpart Warehouse",
            fullyReceived: "Shipment Fully Received",
            allShipments: "All",
            inTransitStatus: "In Transit",
            successfullyReceived: "Successfully Received",
            noShipmentsRecorded: "No shipments registered currently",
            startByAddingNew: "Start by adding new shipment data from the form above",
            instructionsTrack: "Instructions: Enter order and invoice numbers, select status, and click save",
            shipmentDataSaved: "Shipment data saved successfully",
            dataNotEmpty: "❌ No shipment data to export",
            exportSuccess: "✅ Data exported successfully",
            formCleaned: "Form cleaned",
            underModification: "🔄 Under modification - change data and click save",
            updateShipment: "💾 Update shipment data",
            deleteShipmentConfirm: "Are you sure you want to delete shipment",
            shipmentDeleted: "🗑️ Shipment deleted successfully",
            fillOrderAndShipment: "Please enter order number and bill number",
            shipmentAdded: "✅ Shipment added and saved successfully",
            shipmentUpdated: "✅ Shipment data updated successfully",
            resetInventoryConfirm: "Are you sure you want to reset all actual quantities in inventory page?",
            itemsNotDeleted: "(Items will not be deleted, only quantities reset)",
            inventoryCleared: "Inventory quantities cleared",
            deleteAllExpiry: "Are you sure you want to delete all recorded expiry dates?",
            dateRecordDeleted: "Date record deleted",
            deleteAllHints: "Are you sure you want to delete all hints and notes?",
            hintsRecordDeleted: "Hints record deleted",
            languageChanged: "Language changed to",
            arabic: "Arabic 🇸🇦",
            englishLang: "English 🇬🇧",
            importedSuccessfully: "Data updated in all pages",
            notesImported: "Hints and roasteries imported",
            expiryImported: "Expiry items imported",
            inventoryImported: "Inventory data imported",
            fileReadError: "Error reading file",
            inventoryReport: "Inventory_Report",
            expiryReport: "Expiry_Dates_Detailed_Report",
            hintsReport: "Hints_Report",
            comprehensiveReport: "Comprehensive_Detailed_Report",
            shipmentsReport: "Shipment_Tracking",
            tableRowAction: "Order completed"
        }
    };

    function toggleLanguage() {
        currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
        localStorage.setItem('app-language', currentLanguage);
        applyLanguage();
        // لا نعيد تحميل الصفحة - تحديث الترجمات مباشرة يكفي
    }

    function applyLanguage() {
        const html = document.documentElement;
        if (currentLanguage === 'ar') {
            html.lang = 'ar';
            html.dir = 'rtl';
            document.body.style.direction = 'rtl';
        } else {
            html.lang = 'en';
            html.dir = 'ltr';
            document.body.style.direction = 'ltr';
        }
        
        updateAllUIText();
    }

    function updateAllUIText() {
        const t = translations[currentLanguage];
        
        // قائمة شاملة من جميع الترجمات النصية
        const replaceAll = (text) => {
            if (!text) return text;
            
            const replacements = {
                // العناوين الرئيسية
                'الجرد العام': t.inventory,
                'General Inventory': t.inventory,
                'إدارة الكميات وحذف الأصناف': t.inventorySubtitle,
                'Manage quantities and delete items': t.inventorySubtitle,
                'تنبيهات الصلاحية': t.expiry,
                'Expiry Alerts': t.expiry,
                'متابعة التواريخ والدفعات': t.expirySubtitle,
                'Track dates and batches': t.expirySubtitle,
                'دليل القهوة': t.notes,
                'Coffee Guide': t.notes,
                'الوصفات والإيحاءات': t.notesSubtitle,
                'Recipes and notes': t.notesSubtitle,
                'طلبات قيد الانتظار': t.orders,
                'Pending Orders': t.orders,
                'تشمل المعرض والكافيه': t.ordersSubtitle,
                'Showroom and Cafe': t.ordersSubtitle,
                'تتبع الشحنات': t.tracking,
                'Shipment Tracking': t.tracking,
                'بوليصات الشحن والطلبات': t.trackingSubtitle,
                'Bills of lading and orders': t.trackingSubtitle,
                'لوحة القيادة والمتابعة': t.dashboard,
                'Dashboard and Monitoring': t.dashboard,
                'نظرة عامة على حالة العمل': t.overview,
                'Overview of Work Status': t.overview,
                'نظام الإدارة المتكامل - تطوير أحمد الطيب': t.appTitle,
                'Integrated Management System - Development by Ahmed Al-Tayyib': t.appTitle,
                'نسخة محسنة V2.4': t.versionText,
                'Enhanced Version V2.4': t.versionText,
                
                // الأزرار والإجراءات
                'حفظ التغييرات': t.saveChanges,
                'Save Changes': t.saveChanges,
                'حفظ التعديلات': t.saveChangesBtn,
                'Save Changes': t.saveChangesBtn,
                'استيراد (الجرد فقط)': t.importInventory,
                'Import (Inventory Only)': t.importInventory,
                'تصدير (التقرير الشامل)': t.exportReport,
                'Export (Comprehensive Report)': t.exportReport,
                'حذف جميع بيانات التطبيق': t.deleteAllData,
                'Delete All Application Data': t.deleteAllData,
                'إضافة طلب جديد': t.addOrder,
                'Add New Order': t.addOrder,
                'تسجيل الطلب': t.registerOrder,
                'Register Order': t.registerOrder,
                'قائمة الطلبات الجارية': t.ordersList,
                'Current Orders List': t.ordersList,
                'طباعة': t.print,
                'Print': t.print,
                'إدارة الجرد': t.inventoryManagement,
                'Inventory Management': t.inventoryManagement,
                'تصفير كميات الجرد فقط': t.resetInventory,
                'Reset Inventory Quantities Only': t.resetInventory,
                'حذف بيانات الطلبات': t.deleteAllOrders,
                'Delete Order Data': t.deleteAllOrders,
                'حذف الصنف نهائياً': t.deleteCurrentItem,
                'Delete Item Permanently': t.deleteCurrentItem,
                'إضافة (+)': t.add,
                'Add (+)': t.add,
                'خصم (-)': t.subtract,
                'Subtract (-)': t.subtract,
                'تأكيد العملية': t.confirmOperation,
                'Confirm Operation': t.confirmOperation,
                'إدارة التواريخ': t.expiryManagement,
                'Date Management': t.expiryManagement,
                'حذف سجل التواريخ فقط': t.resetExpiryData,
                'Delete Date Record Only': t.resetExpiryData,
                'إضافة التاريخ': t.addDate,
                'Add Date': t.addDate,
                'تقرير الصلاحية التفصيلي': t.expiryReport,
                'Detailed Expiry Report': t.expiryReport,
                'تصفير سجل الإيحاءات فقط': t.resetHints,
                'Reset Hints Record Only': t.resetHints,
                'حفظ الملاحظات': t.saveChangesBtn,
                'Save Notes': t.saveChangesBtn,
                'تصدير Excel': t.exportExcel,
                'Export Excel': t.exportExcel,
                'إضافة / تعديل بوليصة شحن': t.addShipment,
                'Add / Edit Shipment Bill': t.addShipment,
                'حفظ بيانات الشحنة': t.saveShipmentData,
                'Save Shipment Data': t.saveShipmentData,
                'إعادة تعيين': t.resetForm,
                'Reset': t.resetForm,
                'إلغاء التعديل': t.cancel,
                'Cancel Modification': t.cancel,
                'تعديل': t.edit,
                'Edit': t.edit,
                'حذف': t.delete,
                'Delete': t.delete,
                
                // عناوين الحقول
                'رقم الطلب': t.orderNumber,
                'Order Number': t.orderNumber,
                'اسم المحمصة أو الشركة': t.company,
                'Roastery or Company Name': t.company,
                'نوع الطلب': t.orderType,
                'Order Type': t.orderType,
                'تاريخ الطلب': t.orderDate,
                'Order Date': t.orderDate,
                'ملاحظات إضافية': t.additionalNotes,
                'Additional Notes': t.additionalNotes,
                'باركود أو اسم...': t.barcode,
                'Barcode or Name...': t.barcode,
                'الكمية الحالية': t.currentQuantity,
                'Current Quantity': t.currentQuantity,
                'الكمية بالنظام': t.systemQuantity,
                'System Quantity': t.systemQuantity,
                'الكمية': t.quantity,
                'Quantity': t.quantity,
                'سجل الجرد': t.inventoryRecord,
                'Inventory Record': t.inventoryRecord,
                'الكود': t.code,
                'Code': t.code,
                'الصنف': t.item,
                'Item': t.item,
                'النظام': t.system,
                'System': t.system,
                'الفعلي': t.actual,
                'Actual': t.actual,
                'الفارق': t.difference,
                'Difference': t.difference,
                'بحث عن صنف...': t.search,
                'Search for item...': t.search,
                'تاريخ التحميص (اليوم-الشهر-السنة)': t.roastDate,
                'Roast Date (Day-Month-Year)': t.roastDate,
                'مدة الصلاحية (أشهر)': t.expiryDuration,
                'Expiry Duration (Months)': t.expiryDuration,
                'الكمية لهذه الدفعة': t.batchQuantity,
                'Quantity for This Batch': t.batchQuantity,
                'الدفعات والتواريخ المسجلة:': t.registeredDates,
                'Registered Batches and Dates:': t.registeredDates,
                'تاريخ التحميص': t.roastingDate,
                'Roasting Date': t.roastingDate,
                'تاريخ الانتهاء': t.expiryDate,
                'Expiry Date': t.expiryDate,
                'الحالة': t.status,
                'Status': t.status,
                'ابحث بالإيحاء...': t.searchCoffee,
                'Search by hint...': t.searchCoffee,
                'اسم المحمصة': t.roastery,
                'Roastery Name': t.roastery,
                'الإيحاءات / الملاحظات': t.hints,
                'Hints / Notes': t.hints,
                'إدارة ومتابعة شحنات الطلبات': t.manageShipments,
                'Manage and track shipments': t.manageShipments,
                'رقم أمر الشراء/الطلب': t.orderIdField,
                'Purchase Order Number': t.orderIdField,
                'رقم بوليصة الشحن/الفاتورة': t.shipmentNumber,
                'Bill of Lading / Invoice Number': t.shipmentNumber,
                'حالة الشحنة': t.shipmentStatus,
                'Shipment Status': t.shipmentStatus,
                'تم التحضير للشحن': t.prepared,
                'Prepared for Shipment': t.prepared,
                'الشحنة في المستودع': t.inWarehouse,
                'Shipment in Warehouse': t.inWarehouse,
                'الشحنة في الطريق': t.inTransit,
                'Shipment in Transit': t.inTransit,
                'وصلت للمستودع المقابل': t.arrivedWarehouse,
                'Arrived at Counterpart Warehouse': t.arrivedWarehouse,
                'تم استلام الشحنة كاملة': t.received,
                'Shipment Fully Received': t.received,
                'ملاحظات إضافية': t.additionalRemarks,
                'Additional Remarks': t.additionalRemarks,
                'قائمة الشحنات المحفوظة': t.shipmentsList,
                'Saved Shipments List': t.shipmentsList,
                'الكل': t.all,
                'All': t.all,
                'قيد الشحن': t.pending,
                'In Transit': t.pending,
                'وصلت بنجاح': t.delivered,
                'Successfully Received': t.delivered,
                'إجراءات': t.actions,
                'Actions': t.actions,
                'آخر تحديث': t.lastUpdate,
                'Last Update': t.lastUpdate,
                'رقم أمر الشراء': t.purchaseOrder,
                'Purchase Order Number': t.purchaseOrder,
                'رقم الفاتورة/البوليصة': t.invoiceNumber,
                'Invoice/Bill Number': t.invoiceNumber,
                'تم الاستلام': t.hasReceived,
                'Received': t.hasReceived,
                'ملاحظات': t.remarks,
                'Remarks': t.remarks,
                
                // القوائم المنسدلة (Select Options)
                'أمر شراء': t.pickOrder,
                'Purchase Order': t.pickOrder,
                'طلب مواد': t.materialRequest,
                'Material Request': t.materialRequest,
                'طلب تحويل بين الفروع': t.transferRequest,
                'Transfer Between Branches': t.transferRequest,
                'مستودع بضاعة في الطريق': t.goodsInTransit,
                'Goods in Transit Warehouse': t.goodsInTransit,
                'المعرض': t.showroom,
                'Showroom': t.showroom,
                'الكافيه': t.cafe,
                'Cafe': t.cafe,
                
                // الرسائل والتنبيهات
                'امسح الكود للبدء': t.selectItemToStart,
                'Scan code to start': t.selectItemToStart,
                'اختر صنفاً لتعديل بياناته': t.selectItemToEdit,
                'Select item to edit data': t.selectItemToEdit,
                'اختر صنفاً لإدارة تواريخه': t.selectItemToAddDate,
                'Select item to manage dates': t.selectItemToAddDate,
                'لا توجد ملاحظات': t.noHints,
                'No notes': t.noHints,
                'لا توجد طلبات مسجلة في هذا القسم': t.noOrders,
                'No orders registered in this section': t.noOrders,
                'لا توجد شحنات مسجلة حالياً': t.noShipments,
                'No shipments registered currently': t.noShipments,
                'ابدأ بإضافة بيانات شحنة جديدة من النموذج في الأعلى': t.startAddingShipment,
                'Start by adding new shipment data from the form above': t.startAddingShipment,
                'تعليمات: أدخل أرقام الطلبات والفواتير، حدد الحالة، وانقر حفظ لحفظ البيانات': t.instructions,
                'Instructions: Enter order and invoice numbers, select status, and click save': t.instructions,
            };
            
            let result = text;
            for (const [old, newVal] of Object.entries(replacements)) {
                if (result === old) {
                    result = newVal;
                    break;
                }
            }
            return result;
        };
        
        // تحديث جميع العناصر
        document.querySelectorAll('*').forEach(el => {
            // تحديث textContent للعناصر التي لديها نص فقط
            if (el.childNodes.length > 0) {
                Array.from(el.childNodes).forEach(node => {
                    if (node.nodeType === 3) { // Text Node
                        const originalText = node.textContent.trim();
                        const translatedText = replaceAll(originalText);
                        if (translatedText !== originalText && originalText.length > 0) {
                            node.textContent = translatedText;
                        }
                    }
                });
            }
            
            // تحديث جميع option في select
            if (el.tagName === 'OPTION') {
                const originalText = el.textContent;
                const translatedText = replaceAll(originalText);
                if (translatedText !== originalText) {
                    el.textContent = translatedText;
                }
            }
            
            // تحديث placeholder
            if (el.placeholder) {
                const originalPlaceholder = el.placeholder;
                const translatedPlaceholder = replaceAll(originalPlaceholder);
                if (translatedPlaceholder !== originalPlaceholder) {
                    el.placeholder = translatedPlaceholder;
                }
            }
            
            // تحديث title
            if (el.title) {
                const originalTitle = el.title;
                const translatedTitle = replaceAll(originalTitle);
                if (translatedTitle !== originalTitle) {
                    el.title = translatedTitle;
                }
            }
            
            // تحديث aria-label
            if (el.getAttribute('aria-label')) {
                const originalLabel = el.getAttribute('aria-label');
                const translatedLabel = replaceAll(originalLabel);
                if (translatedLabel !== originalLabel) {
                    el.setAttribute('aria-label', translatedLabel);
                }
            }
        });

        // تحديث العنوان
        document.title = t.appTitle;
        
        // تحديث زر اللغة
        const langBtn = document.getElementById('lang-text');
        if (langBtn) {
            langBtn.textContent = currentLanguage === 'ar' ? 'English' : 'عربي';
        }
        
        showToast(`✅ ${t.languageChanged} ${currentLanguage === 'ar' ? t.arabic : t.englishLang}`);
    }

    function getTranslation(key) {
        return translations[currentLanguage]?.[key] || translations['ar']?.[key] || key;
    }

    function initLanguage() {
        applyLanguage();
    }

    function saveAllData() {
        localStorage.setItem(STORAGE_KEY_INV, JSON.stringify(inventory));
        localStorage.setItem(STORAGE_KEY_ORDERS, JSON.stringify(ordersData));
        saveTracking();
        updateDashboardStats();
    }

    function saveAllDataManual() {
        saveAllData();
        showToast('تم حفظ جميع البيانات بنجاح', 'success');
    }

    function clearPageData(viewName) {
        if (viewName === 'inventory') {
            if (confirm('هل أنت متأكد من تصفير جميع الكميات الفعلية في صفحة الجرد؟ (لن يتم حذف الأصناف، فقط تصفير الكميات)')) {
                inventory.forEach(item => item.actualQty = 0);
                saveAllData();
                renderInvTable();
                resetInvUI();
                showToast('تم تصفير كميات الجرد');
            }
        } else if (viewName === 'expiry') {
             if (confirm('هل أنت متأكد من حذف جميع تواريخ الصلاحية المسجلة؟ (لن يتم حذف الأصناف)')) {
                inventory.forEach(item => item.batches = []);
                saveAllData();
                renderExpTable();
                resetExpUI();
                showToast('تم حذف سجل التواريخ');
            }
        } else if (viewName === 'notes') {
            if (confirm('هل أنت متأكد من حذف جميع الإيحاءات والملاحظات؟ (لن يتم حذف الأصناف)')) {
                inventory.forEach(item => { item.notes = ""; item.roastery = ""; });
                saveAllData();
                renderNoteTable();
                resetNoteUI();
                showToast('تم حذف سجل الإيحاءات');
            }
        } else if (viewName === 'orders') {
            if (confirm('هل أنت متأكد من حذف جميع بيانات الطلبات؟')) {
                localStorage.removeItem(STORAGE_KEY_ORDERS);
                ordersData = { showroom: [], cafe: [] };
                saveAllData();
                renderOrdersTable();
                showToast('تم حذف بيانات الطلبات');
            }
        }
    }

    function clearAllData() {
        if (confirm('هل أنت متأكد تماماً من حذف جميع بيانات التطبيق بالكامل (الجرد والطلبات والملاحظات)؟ لا يمكن التراجع عن هذا الإجراء!')) {
            localStorage.removeItem(STORAGE_KEY_INV);
            localStorage.removeItem(STORAGE_KEY_ORDERS);
            showToast('تم حذف جميع بيانات التطبيق بنجاح', 'error');
            setTimeout(() => location.reload(), 500); 
        }
    }

    // ========== ORDERS ==========
    function setOrderSource(source) {
        activeOrderSource = source;
        const btnS = document.getElementById('btn-src-showroom');
        const btnC = document.getElementById('btn-src-cafe');
        
        btnS.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all border";
        btnC.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all border";

        if(source === 'showroom') {
            btnS.classList.add('bg-showroom-600', 'text-white', 'border-showroom-600', 'shadow-md');
            btnC.classList.add('bg-white', 'text-slate-500', 'border-slate-200');
        } else {
            btnC.classList.add('bg-cafe-600', 'text-white', 'border-cafe-600', 'shadow-md');
            btnS.classList.add('bg-white', 'text-slate-500', 'border-slate-200');
        }
    }

    function switchOrdersTab(tab) {
        activeOrdersTab = tab;
        
        const tShow = document.getElementById('tab-showroom');
        const tCafe = document.getElementById('tab-cafe');

        tShow.className = "flex-1 py-3 bg-white rounded-xl shadow-sm border-2 border-transparent text-slate-400 font-bold transition-all relative overflow-hidden group opacity-60";
        tCafe.className = "flex-1 py-3 bg-white rounded-xl shadow-sm border-2 border-transparent text-slate-400 font-bold transition-all relative overflow-hidden group opacity-60";

        if(tab === 'showroom') {
            tShow.className = "flex-1 py-3 bg-white rounded-xl shadow-md border-2 border-showroom-600 text-showroom-600 font-bold transition-all relative overflow-hidden group";
            document.getElementById('orders-list-title').innerHTML = '<i class="fa-solid fa-store text-showroom-600"></i> قائمة طلبات المعرض';
        } else {
            tCafe.className = "flex-1 py-3 bg-white rounded-xl shadow-md border-2 border-cafe-600 text-cafe-600 font-bold transition-all relative overflow-hidden group";
            document.getElementById('orders-list-title').innerHTML = '<i class="fa-solid fa-mug-saucer text-cafe-600"></i> قائمة طلبات الكافيه';
        }

        renderOrdersTable();
    }

    function saveOrder() {
        const num = document.getElementById('ord-num').value;
        const company = document.getElementById('ord-company').value;
        const type = document.getElementById('ord-type').value;
        const date = document.getElementById('ord-date').value;
        const notes = document.getElementById('ord-notes').value;
        const editId = document.getElementById('ord-edit-id').value;

        if(!num || !company || !date) {
            showToast('يرجى ملء جميع الحقول', 'error');
            return;
        }

        if(editId) {
            const list = ordersData[activeOrderSource];
            const order = list.find(o => o.id === parseInt(editId));
            if(order) {
                order.number = num;
                order.company = company;
                order.type = type;
                order.date = date;
                order.notes = notes;
                showToast('تم تحديث الطلب بنجاح');
                cancelOrderEdit();
            }
        } else {
            const newOrder = {
                id: Date.now(),
                number: num,
                company: company,
                type: type,
                date: date,
                notes: notes,
                status: 'pending'
            };

            if(activeOrderSource === 'showroom') {
                ordersData.showroom.unshift(newOrder);
            } else {
                ordersData.cafe.unshift(newOrder);
            }
            showToast('تم إضافة الطلب بنجاح');
        }

        saveAllData();
        
        if(activeOrderSource === activeOrdersTab) {
            renderOrdersTable();
        }

        document.getElementById('ord-num').value = '';
        document.getElementById('ord-company').value = '';
        document.getElementById('ord-type').selectedIndex = 0;
        document.getElementById('ord-date').valueAsDate = new Date();
        document.getElementById('ord-notes').value = '';
    }

    function editOrder(id) {
        const list = ordersData[activeOrdersTab];
        const order = list.find(o => o.id === id);
        if(!order) return;

        setOrderSource(activeOrdersTab);
        
        document.getElementById('ord-num').value = order.number;
        document.getElementById('ord-company').value = order.company;
        document.getElementById('ord-type').value = order.type;
        document.getElementById('ord-date').value = order.date;
        document.getElementById('ord-notes').value = order.notes || '';
        document.getElementById('ord-edit-id').value = order.id;
        
        document.getElementById('order-form-title').innerText = 'تعديل الطلب';
        document.getElementById('order-save-btn-text').innerText = 'حفظ التعديلات';
        document.getElementById('cancel-edit-btn').classList.remove('hidden');
        
        document.getElementById('ord-num').focus();
    }

    function cancelOrderEdit() {
        document.getElementById('ord-num').value = '';
        document.getElementById('ord-company').value = '';
        document.getElementById('ord-type').selectedIndex = 0;
        document.getElementById('ord-date').valueAsDate = new Date();
        document.getElementById('ord-notes').value = '';
        document.getElementById('ord-edit-id').value = '';
        
        document.getElementById('order-form-title').innerText = 'إضافة طلب جديد';
        document.getElementById('order-save-btn-text').innerText = 'تسجيل الطلب';
        document.getElementById('cancel-edit-btn').classList.add('hidden');
    }

    function toggleOrderStatus(id) {
        const list = ordersData[activeOrdersTab];
        const order = list.find(o => o.id === id);
        if(order) {
            order.status = order.status === 'completed' ? 'pending' : 'completed';
            ordersData[activeOrdersTab].sort((a, b) => {
                if (a.status === b.status) return b.id - a.id;
                return a.status === 'completed' ? 1 : -1;
            });
            saveAllData();
            renderOrdersTable();
            showToast(order.status === 'completed' ? 'تم إنجاز الطلب' : 'تم إعادة الطلب لقائمة الانتظار');
        }
    }

    function renderOrdersTable() {
        const tbody = document.getElementById('orders-table-body');
        const emptyState = document.getElementById('orders-empty');
        tbody.innerHTML = '';
        
        const list = ordersData[activeOrdersTab] || [];

        if (list.length === 0) {
            emptyState.classList.remove('hidden');
            return;
        } else {
            emptyState.classList.add('hidden');
        }

        list.forEach(order => {
            const isCompleted = order.status === 'completed';
            const daysDiff = calculateDaysSince(order.date);
            
            let rowClass = isCompleted ? "bg-slate-50 opacity-60" : "hover:bg-slate-50 transition";
            let daysClass = "font-bold text-slate-600";
            let warningIcon = "";

            if (!isCompleted && daysDiff > 7) {
                rowClass = "bg-red-50 hover:bg-red-100 transition";
                daysClass = "font-black text-red-600";
                warningIcon = `<i class="fa-solid fa-triangle-exclamation text-red-500 ml-1"></i>`;
            } else if (isCompleted) {
                 daysClass = "text-slate-400 line-through";
            }

            const tr = document.createElement('tr');
            tr.className = rowClass;
            tr.innerHTML = `
                <td class="p-3 text-center">
                    <button onclick="toggleOrderStatus(${order.id})" class="w-8 h-8 rounded-full flex items-center justify-center transition ${isCompleted ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-300 hover:bg-green-50 hover:text-green-500'}">
                        <i class="fa-solid fa-check"></i>
                    </button>
                </td>
                <td class="p-3 font-mono font-bold text-slate-700 ${isCompleted ? 'line-through decoration-slate-400' : ''}">${order.number}</td>
                <td class="p-3 font-bold text-slate-800 ${isCompleted ? 'text-slate-500' : ''}">${order.company}</td>
                <td class="p-3 text-xs w-28 wrap-text">
                    <span class="px-2 py-1 rounded bg-white border border-slate-200 text-slate-600 block">${order.type}</span>
                </td>
                <td class="p-3 text-xs text-slate-500 wrap-text max-w-[150px]">${order.notes || '-'}</td>
                <td class="p-3 text-center text-slate-500 text-xs font-mono">${formatDateDisplay(order.date)}</td>
                <td class="p-3 text-center ${daysClass}">
                   ${daysDiff} يوم ${warningIcon}
                </td>
                <td class="p-3 text-center no-print">
                    <button onclick="editOrder(${order.id})" class="text-blue-500 hover:text-blue-700 transition px-2 ml-1">
                        <i class="fa-solid fa-edit"></i>
                    </button>
                    <button onclick="deleteOrder(${order.id})" class="text-slate-400 hover:text-red-500 transition px-2">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function calculateDaysSince(dateString) {
        const pastDate = new Date(dateString);
        const today = new Date();
        pastDate.setHours(0,0,0,0);
        today.setHours(0,0,0,0);
        const diffTime = Math.abs(today - pastDate);
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    }

    function deleteOrder(id) {
        if(confirm('هل أنت متأكد من حذف هذا الطلب نهائياً؟')) {
            ordersData[activeOrdersTab] = ordersData[activeOrdersTab].filter(o => o.id !== id);
            saveAllData();
            renderOrdersTable();
            showToast('تم حذف الطلب');
        }
    }

    // ========== INVENTORY ==========
    function resetInvUI() {
        document.getElementById('inv-empty').classList.remove('hidden');
        document.getElementById('inv-card').classList.add('hidden');
        document.getElementById('inv-search').value = '';
        document.getElementById('inv-results').classList.add('hidden');
    }

    function handleInventorySearch(query) {
        query = query.toLowerCase().trim();
        const list = document.getElementById('inv-results');
        list.innerHTML = '';
        
        if (!query) {
            list.classList.add('hidden');
            renderInvTable();
            return;
        }

        // Direct Scan Check: If exact match found, select immediately
        const exactMatchIndex = inventory.findIndex(item => item.code.toLowerCase() === query);
        if (exactMatchIndex !== -1) {
             selectItemInventory(exactMatchIndex);
             return;
        }

        let matches = inventory.map((item, idx) => ({ ...item, idx })).filter(item => 
            item.name.toLowerCase().includes(query) || item.code.toLowerCase().includes(query)
        );

        const dropdownMatches = matches.slice(0, 5);

        if (dropdownMatches.length > 0) {
            list.classList.remove('hidden');
            dropdownMatches.forEach(m => {
                const li = document.createElement('li');
                li.className = 'p-3 border-b border-slate-50 hover:bg-slate-50 cursor-pointer flex justify-between items-center';
                li.innerHTML = `<span class="font-bold text-slate-700 text-xs">${m.name}</span> <span class="text-[10px] font-mono bg-slate-100 px-1 rounded">${m.code}</span>`;
                li.onclick = () => selectItemInventory(m.idx);
                list.appendChild(li);
            });
        } else {
            if (query.length > 1) {
                const li = document.createElement('li');
                li.className = 'p-3 bg-brand-50 hover:bg-brand-100 cursor-pointer text-brand-700 font-bold text-xs text-center';
                li.innerHTML = `<i class="fa-solid fa-plus"></i> إضافة صنف جديد: ${query}`;
                li.onclick = () => openAddItemModal(query);
                list.appendChild(li);
                list.classList.remove('hidden');
            } else {
                list.classList.add('hidden');
            }
        }
        
        renderInvTable(query);
    }

    function selectItemInventory(idx) {
        selectedItemIdx = idx;
        const item = inventory[idx];
        
        document.getElementById('inv-results').classList.add('hidden');
        document.getElementById('inv-search').value = '';
        document.getElementById('inv-empty').classList.add('hidden');
        document.getElementById('inv-card').classList.remove('hidden');
        document.getElementById('inv-name').innerText = item.name;
        document.getElementById('inv-code').innerText = item.code;
        document.getElementById('inv-sys-qty').innerText = item.sysQty;
        document.getElementById('inv-current-qty').innerText = item.actualQty;
        document.getElementById('inv-input-qty').value = '';
        document.getElementById('inv-input-qty').focus();
        renderInvTable();
    }

    function setInvMode(m) {
        invMode = m;
        const btnAdd = document.getElementById('btn-inv-add');
        const btnSub = document.getElementById('btn-inv-sub');
        if (m === 'add') {
            btnAdd.className = "flex-1 py-2 rounded-lg text-xs font-bold bg-brand-600 text-white shadow-md transition-colors";
            btnSub.className = "flex-1 py-2 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 transition-colors";
        } else {
            btnAdd.className = "flex-1 py-2 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 transition-colors";
            btnSub.className = "flex-1 py-2 rounded-lg text-xs font-bold bg-red-500 text-white shadow-md transition-colors";
        }
        document.getElementById('inv-input-qty').focus();
    }

    function submitInventory() {
        if (selectedItemIdx === -1) return;
        const inputField = document.getElementById('inv-input-qty');
        const qtyVal = Number(inputField.value);
        if (!qtyVal && qtyVal !== 0) return;

        if (invMode === 'add') {
            inventory[selectedItemIdx].actualQty += qtyVal;
        } else {
            inventory[selectedItemIdx].actualQty = Math.max(0, inventory[selectedItemIdx].actualQty - qtyVal);
        }

        document.getElementById('inv-current-qty').innerText = inventory[selectedItemIdx].actualQty;
        inputField.value = '';
        inputField.focus();
        
        saveAllData();
        renderInvTable();
        showToast('تم تحديث الكمية');
    }

    // New Function to delete item from inventory
    function deleteCurrentItem() {
        if (selectedItemIdx === -1) return;
        
        if (confirm(`هل أنت متأكد من حذف الصنف "${inventory[selectedItemIdx].name}" نهائياً من النظام؟`)) {
            inventory.splice(selectedItemIdx, 1);
            saveAllData();
            resetInvUI();
            renderInvTable();
            showToast('تم حذف الصنف بنجاح', 'error');
        }
    }

    function renderInvTable(filter = '') {
        const tbody = document.getElementById('inv-table-body');
        tbody.innerHTML = '';
        
        inventory.forEach((item, idx) => {
            if (filter && !item.name.toLowerCase().includes(filter) && !item.code.toLowerCase().includes(filter)) return;

            const diff = item.actualQty - item.sysQty;
            let diffColor = diff === 0 ? 'text-emerald-500' : (diff > 0 ? 'text-blue-500' : 'text-red-500');
            let diffSign = diff > 0 ? '+' : '';

            const tr = document.createElement('tr');
            tr.className = `hover:bg-blue-50 cursor-pointer transition ${idx === selectedItemIdx ? 'bg-blue-100' : ''}`;
            tr.onclick = () => selectItemInventory(idx);
            tr.innerHTML = `
                <td class="p-3 font-mono text-slate-500">${item.code}</td>
                <td class="p-3 font-bold text-slate-700">${item.name}</td>
                <td class="p-3 text-center text-slate-400 font-mono">${item.sysQty}</td>
                <td class="p-3 text-center text-brand-900 font-black bg-white/50 rounded">${item.actualQty}</td>
                <td class="p-3 text-center font-bold ${diffColor} dir-ltr">${diffSign}${diff}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function openAddItemModal(code) {
        document.getElementById('addItemModal').classList.remove('hidden');
        document.getElementById('addItemModal').classList.add('flex');
        document.getElementById('new-code').value = code;
        document.getElementById('new-name').value = '';
        document.getElementById('new-sys-qty').value = '';
        document.getElementById('new-name').focus();
    }

    function confirmAddItem() {
        const code = document.getElementById('new-code').value;
        const name = document.getElementById('new-name').value;
        const sys = Number(document.getElementById('new-sys-qty').value) || 0;
        
        if (name) {
            inventory.push({ code, name, sysQty: sys, actualQty: 0, batches: [], roastery: '', notes: '' });
            document.getElementById('addItemModal').classList.add('hidden');
            saveAllData();
            selectItemInventory(inventory.length - 1);
            showToast('تم إضافة الصنف بنجاح');
        }
    }

    // ========== EXPIRY ==========
    function resetExpUI() {
        document.getElementById('exp-empty').classList.remove('hidden');
        document.getElementById('exp-card').classList.add('hidden');
        cancelBatchEdit();
    }

    function addBatch() {
        if (selectedItemIdx === -1) return;
        const dateStr = document.getElementById('exp-date').value;
        const qty = Number(document.getElementById('exp-qty').value);
        const duration = Number(document.getElementById('exp-duration').value) || 12;

        if (!dateStr || !qty) {
            showToast('يرجى إدخال التاريخ والكمية', 'error');
            return;
        }

        if (editingBatchId) {
             const batchIndex = inventory[selectedItemIdx].batches.findIndex(b => b.id === editingBatchId);
             if (batchIndex !== -1) {
                 inventory[selectedItemIdx].batches[batchIndex].date = dateStr;
                 inventory[selectedItemIdx].batches[batchIndex].qty = qty;
                 inventory[selectedItemIdx].batches[batchIndex].duration = duration;
                 showToast('تم تحديث الدفعة');
                 cancelBatchEdit();
             }
        } else {
            const newBatch = { id: Date.now(), date: dateStr, qty: qty, duration: duration };
            inventory[selectedItemIdx].batches.push(newBatch);
            showToast('تم إضافة الدفعة');
        }

        inventory[selectedItemIdx].batches.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        saveAllData();
        renderBatchesList(inventory[selectedItemIdx]);
        renderExpTable();
        
        document.getElementById('exp-qty').value = '';
        document.getElementById('exp-date').value = '';
    }
    
    function editBatch(batchId) {
        if (selectedItemIdx === -1) return;
        const batch = inventory[selectedItemIdx].batches.find(b => b.id === batchId);
        if(batch) {
            document.getElementById('exp-date').value = batch.date;
            document.getElementById('exp-qty').value = batch.qty;
            document.getElementById('exp-duration').value = batch.duration;
            
            editingBatchId = batchId;
            document.getElementById('btn-add-batch').innerHTML = '<i class="fa-solid fa-save"></i> حفظ التعديل';
            document.getElementById('btn-cancel-batch').classList.remove('hidden');
        }
    }

    function cancelBatchEdit() {
        editingBatchId = null;
        document.getElementById('exp-qty').value = '';
        document.getElementById('exp-date').value = '';
        document.getElementById('exp-duration').value = '12';
        document.getElementById('btn-add-batch').innerHTML = '<i class="fa-solid fa-plus"></i> إضافة التاريخ';
        document.getElementById('btn-cancel-batch').classList.add('hidden');
    }

    function deleteBatch(batchId) {
         if (selectedItemIdx === -1) return;
         if(confirm('حذف هذا التاريخ؟')) {
            inventory[selectedItemIdx].batches = inventory[selectedItemIdx].batches.filter(b => b.id !== batchId);
            saveAllData();
            renderBatchesList(inventory[selectedItemIdx]);
            renderExpTable();
            showToast('تم حذف الدفعة');
            if (editingBatchId === batchId) cancelBatchEdit();
         }
    }

    function renderBatchesList(item) {
        const list = document.getElementById('exp-batches-list');
        list.innerHTML = '';
        
        if (!item.batches || item.batches.length === 0) {
            list.innerHTML = '<div class="text-xs text-slate-400 text-center py-2">لا توجد دفعات مسجلة</div>';
            return;
        }

        item.batches.forEach(batch => {
            const { remainingDays, label, colorClass, expiryDateStr } = calcExpiry(batch.date, batch.duration);
            const div = document.createElement('div');
            div.className = 'bg-white border border-slate-100 p-2 rounded-lg flex justify-between items-center shadow-sm';
            div.innerHTML = `
                <div>
                    <div class="text-[10px] text-slate-400">تحميص: ${formatDateDisplay(batch.date)}</div>
                    <div class="text-[10px] text-red-400">انتهاء: ${expiryDateStr}</div>
                    <div class="text-xs font-bold text-slate-700">الكمية: ${batch.qty}</div>
                </div>
                <div class="text-right flex gap-2 items-center">
                    <span class="block text-[10px] px-2 py-0.5 rounded ${colorClass} mb-1">${label}</span>
                    <div>
                        <button onclick="editBatch(${batch.id})" class="text-[10px] text-blue-400 hover:text-blue-600 underline ml-2">تعديل</button>
                        <button onclick="deleteBatch(${batch.id})" class="text-[10px] text-red-400 hover:text-red-600 underline">حذف</button>
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function calcExpiry(roastDateStr, durationMonths = 12) {
        if(!roastDateStr) return { remainingDays: 0, label: '-', colorClass: '', expiryDateStr: '-' };
        
        const prodDate = new Date(roastDateStr);
        const expDate = new Date(prodDate);
        expDate.setMonth(expDate.getMonth() + durationMonths);
        
        const today = new Date();
        const diffTime = expDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        let label = '';
        let colorClass = '';

        if (diffDays < 0) {
            label = `منتهي (${Math.abs(diffDays)} يوم)`;
            colorClass = 'bg-red-100 text-red-700';
        } else if (diffDays <= 30) {
            label = `باقي ${diffDays} يوم`;
            colorClass = 'bg-amber-100 text-amber-700';
        } else {
            const months = Math.floor(diffDays / 30);
            label = `باقي ${months} شهر`;
            colorClass = 'bg-emerald-100 text-emerald-700';
        }
        
        const d = expDate.getDate().toString().padStart(2, '0');
        const m = (expDate.getMonth() + 1).toString().padStart(2, '0');
        const y = expDate.getFullYear();
        const expiryDateStr = `${d}/${m}/${y}`;

        return { remainingDays: diffDays, label, colorClass, expiryDateStr, expDateObj: expDate };
    }

    function renderExpTable(filter = '') {
        const tbody = document.getElementById('exp-table-body');
        tbody.innerHTML = '';

        inventory.forEach((item, idx) => {
            if (filter && !item.name.toLowerCase().includes(filter)) return;
            
            // Fix: Always render the item even if no batches exist so it can be selected
            if (!item.batches || item.batches.length === 0) {
                 const tr = document.createElement('tr');
                 tr.className = `hover:bg-amber-50 cursor-pointer transition ${idx === selectedItemIdx ? 'bg-amber-100' : ''}`;
                 tr.onclick = () => selectItem(idx, 'expiry');
                 tr.innerHTML = `
                    <td class="p-3 font-mono text-slate-500 text-xs">${item.code}</td>
                    <td class="p-3 font-bold text-slate-700">${item.name}</td>
                    <td class="p-3 text-center text-slate-300">-</td>
                    <td class="p-3 text-center text-slate-300">-</td>
                    <td class="p-3 text-center text-slate-300">0</td>
                    <td class="p-3 text-center text-slate-300 text-[10px]">اضغط لإضافة تاريخ</td>
                `;
                tbody.appendChild(tr);
            } else {
                item.batches.forEach((batch) => {
                    const { label, colorClass, expiryDateStr } = calcExpiry(batch.date, batch.duration);
                    const tr = document.createElement('tr');
                    tr.className = `hover:bg-amber-50 cursor-pointer transition border-b border-slate-50 ${idx === selectedItemIdx ? 'bg-amber-100' : ''}`;
                    tr.onclick = () => selectItem(idx, 'expiry');

                    tr.innerHTML = `
                        <td class="p-3 font-mono text-slate-500 text-xs">${item.code}</td>
                        <td class="p-3 font-bold text-slate-700">${item.name}</td>
                        <td class="p-3 text-center font-mono text-slate-600">${formatDateDisplay(batch.date)}</td>
                        <td class="p-3 text-center font-mono text-red-600 font-bold">${expiryDateStr}</td>
                        <td class="p-3 text-center font-bold text-slate-800">${batch.qty}</td>
                        <td class="p-3 text-center"><span class="px-2 py-1 rounded text-[10px] ${colorClass}">${label}</span></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        });
    }

    // ========== NOTES ==========
    function resetNoteUI() {
        document.getElementById('note-empty').classList.remove('hidden');
        document.getElementById('note-card').classList.add('hidden');
    }

    function saveNote() {
        if (selectedItemIdx === -1) return;
        inventory[selectedItemIdx].roastery = document.getElementById('note-roastery').value;
        inventory[selectedItemIdx].notes = document.getElementById('note-text').value;
        saveAllData();
        renderNoteTable();
        showToast('تم حفظ الملاحظات');
    }

    function renderNoteTable(filter = '') {
        const tbody = document.getElementById('note-table-body');
        tbody.innerHTML = '';

        inventory.forEach((item, idx) => {
            const searchStr = (item.name + (item.roastery||'') + (item.notes||'')).toLowerCase();
            if (filter && !searchStr.includes(filter)) return;

            const tr = document.createElement('tr');
            tr.className = `hover:bg-emerald-50 cursor-pointer transition ${idx === selectedItemIdx ? 'bg-emerald-100' : ''}`;
            tr.onclick = () => selectItem(idx, 'notes');
            
            const roasteryDisplay = item.roastery ? `<span class="text-emerald-700 font-bold"><i class="fa-solid fa-fire-burner text-xs"></i> ${item.roastery}</span>` : '<span class="text-slate-300">-</span>';
            const notesDisplay = item.notes ? `<span class="text-slate-600 text-xs">${item.notes}</span>` : '<span class="text-slate-300 text-[10px]">لا توجد ملاحظات</span>';

            tr.innerHTML = `
                <td class="p-3 font-mono text-slate-400 text-xs">${item.code}</td>
                <td class="p-3 font-bold text-slate-700">${item.name}</td>
                <td class="p-3">${roasteryDisplay}</td>
                <td class="p-3">${notesDisplay}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // ========== SHARED ==========
    function showToast(msg, type='success') {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.className = `fixed bottom-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl font-bold text-sm transition-all duration-300 z-[100] ${type === 'error' ? 'bg-red-600 text-white' : 'bg-brand-900 text-white'}`;
        t.style.opacity = '1';
        t.style.bottom = '30px';
        setTimeout(() => {
            t.style.opacity = '0';
            t.style.bottom = '5px';
        }, 2000);
    }

    function formatDateDisplay(dateStr) {
        if (!dateStr) return '-';
        const parts = dateStr.split('-');
        if (parts.length !== 3) return dateStr;
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }

    function handleSearch(context, query) {
        query = query.toLowerCase();
        const resultsId = context === 'expiry' ? 'exp-results' : 'note-results';
        const list = document.getElementById(resultsId);
        list.innerHTML = '';
        
        if (!query) {
            list.classList.add('hidden');
            if (context === 'expiry') renderExpTable();
            if (context === 'notes') renderNoteTable();
            return;
        }

        let matches = inventory.map((item, idx) => ({ ...item, idx })).filter(item => {
            const basicMatch = item.name.toLowerCase().includes(query) || item.code.includes(query);
            if (context === 'notes') {
                return basicMatch || (item.notes && item.notes.toLowerCase().includes(query)) || (item.roastery && item.roastery.toLowerCase().includes(query));
            }
            return basicMatch;
        });

        const dropdownMatches = matches.slice(0, 5);

        if (dropdownMatches.length > 0) {
            list.classList.remove('hidden');
            dropdownMatches.forEach(m => {
                const li = document.createElement('li');
                li.className = 'p-3 border-b border-slate-50 hover:bg-slate-50 cursor-pointer flex justify-between items-center';
                li.innerHTML = `<span class="font-bold text-slate-700 text-xs">${m.name}</span> <span class="text-[10px] font-mono bg-slate-100 px-1 rounded">${m.code}</span>`;
                li.onclick = () => selectItem(m.idx, context);
                list.appendChild(li);
            });
        } else {
            list.classList.add('hidden');
        }
        
        if (context === 'notes') renderNoteTable(query);
        else if (context === 'expiry') renderExpTable(query);
    }

    function selectItem(idx, context) {
        selectedItemIdx = idx;
        const item = inventory[idx];
        
        document.querySelectorAll('ul[id$="-results"]').forEach(ul => ul.classList.add('hidden'));
        document.querySelectorAll('input[id$="-search"]').forEach(inp => inp.value = '');

        if (context === 'expiry') {
            document.getElementById('exp-empty').classList.add('hidden');
            document.getElementById('exp-card').classList.remove('hidden');
            document.getElementById('exp-name').innerText = item.name;
            document.getElementById('exp-date').value = '';
            document.getElementById('exp-qty').value = '';
            document.getElementById('exp-duration').value = '12';
            cancelBatchEdit();
            renderBatchesList(item);
        }
        else if (context === 'notes') {
            document.getElementById('note-empty').classList.add('hidden');
            document.getElementById('note-card').classList.remove('hidden');
            document.getElementById('note-name').innerText = item.name;
            document.getElementById('note-code').innerText = item.code;
            document.getElementById('note-roastery').value = item.roastery || '';
            document.getElementById('note-text').value = item.notes || '';
        }
    }

    // ========== IMPORT/EXPORT ==========
    function updateOrAddItem(code, name, sysQty, roastery = null, notes = null) {
        let item = inventory.find(x => x.code === String(code));
        if (!item) {
            item = { 
                code: String(code), 
                name: name || 'صنف جديد', 
                sysQty: Number(sysQty) || 0, 
                actualQty: 0, 
                batches: [], 
                roastery: roastery || '', 
                notes: notes || '' 
            };
            inventory.push(item);
        } else {
            if (name) item.name = name;
            if (sysQty !== undefined && sysQty !== null) item.sysQty = Number(sysQty);
            if (roastery !== null) item.roastery = roastery;
            if (notes !== null) item.notes = notes;
        }
    }

    function handleGlobalImport(evt) {
        processExcel(evt, (row) => {
            const code = row[0];
            if (code) {
                updateOrAddItem(code, row[1], row[2], row[3], row[4]);
            }
        }, 'تم تحديث البيانات في جميع الصفحات');
    }

    function exportGlobalData() {
        const data = [];
        inventory.forEach(item => {
            if (item.batches && item.batches.length > 0) {
                item.batches.forEach(b => {
                    const { expiryDateStr } = calcExpiry(b.date, b.duration);
                    data.push({
                        'الكود': item.code,
                        'الصنف': item.name,
                        'المحمصة': item.roastery,
                        'الملاحظات': item.notes,
                        'الكمية بالنظام': item.sysQty,
                        'الكمية الفعلية': item.actualQty,
                        'الفارق': item.actualQty - item.sysQty,
                        'تاريخ التحميص': formatDateDisplay(b.date),
                        'تاريخ الانتهاء': expiryDateStr,
                        'كمية الدفعة': b.qty
                    });
                });
            } else {
                data.push({
                    'الكود': item.code,
                    'الصنف': item.name,
                    'المحمصة': item.roastery,
                    'الملاحظات': item.notes,
                    'الكمية بالنظام': item.sysQty,
                    'الكمية الفعلية': item.actualQty,
                    'الفارق': item.actualQty - item.sysQty,
                    'تاريخ التحميص': '-',
                    'تاريخ الانتهاء': '-',
                    'كمية الدفعة': '-'
                });
            }
        });
        downloadExcel(data, "التقرير_الشامل_المفصل");
    }

    function handleInventoryImport(evt) {
        processExcel(evt, (row) => {
            const code = row[0];
            if (code) {
                let item = inventory.find(x => x.code === String(code));
                if (item) {
                    item.sysQty = Number(row[2]) || item.sysQty; 
                } else {
                    updateOrAddItem(code, row[1], row[2]);
                }
            }
        }, 'تم استيراد بيانات الجرد');
    }

    function exportInventoryData() {
        const data = inventory.map(item => ({
            'الكود': item.code,
            'اسم الصنف': item.name,
            'الكمية بالنظام': item.sysQty,
            'الكمية الفعلية': item.actualQty,
            'الفارق (زيادة/نقص)': item.actualQty - item.sysQty
        }));
        downloadExcel(data, "تقرير_الجرد");
    }

    function handleExpiryImport(evt) {
        processExcel(evt, (row) => {
            const code = row[0];
            if (code) updateOrAddItem(code, row[1], null); 
        }, 'تم استيراد أصناف الصلاحية');
    }

    function exportExpiryData() {
        const data = [];
        inventory.forEach(item => {
            if (!item.batches || item.batches.length === 0) {
                 data.push({
                    'الكود': item.code,
                    'اسم الصنف': item.name,
                    'تاريخ التحميص': '-',
                    'تاريخ الانتهاء': '-',
                    'الكمية': 0,
                    'الحالة': 'لا توجد تواريخ'
                });
            } else {
                item.batches.forEach(b => {
                    const { label, expiryDateStr } = calcExpiry(b.date, b.duration);
                    data.push({
                        'الكود': item.code,
                        'اسم الصنف': item.name,
                        'تاريخ التحميص': formatDateDisplay(b.date),
                        'تاريخ الانتهاء': expiryDateStr,
                        'الكمية': b.qty,
                        'الحالة': label
                    });
                });
            }
        });
        downloadExcel(data, "تقرير_تواريخ_الانتهاء_المفصل");
    }

    function handleNotesImport(evt) {
        processExcel(evt, (row) => {
            const code = row[0];
            if (code) {
                 let item = inventory.find(x => x.code === String(code));
                 if(item) {
                     if(row[2]) item.roastery = row[2];
                     if(row[3]) item.notes = row[3];
                 } else {
                     updateOrAddItem(code, row[1], 0, row[2], row[3]);
                 }
            }
        }, 'تم استيراد الإيحاءات والمحامص');
    }

    function exportNotesData() {
        const data = inventory.map(item => ({
            'اسم المحمصة': item.roastery,
            'الكود': item.code,
            'اسم الصنف': item.name,
            'الإيحاء / الملاحظات': item.notes
        }));
        downloadExcel(data, "تقرير_الإيحاءات");
    }

    function processExcel(evt, rowCallback, successMsg) {
        const file = evt.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                
                for(let i=1; i<rows.length; i++) {
                    rowCallback(rows[i]);
                }
                saveAllData();
                
                if (currentView === 'inventory') renderInvTable();
                else if (currentView === 'expiry') renderExpTable();
                else if (currentView === 'notes') renderNoteTable();
                else if (currentView === 'home') updateDashboardStats();

                showToast(successMsg);
                evt.target.value = '';
            } catch(err) {
                console.error(err);
                showToast('خطأ في قراءة الملف', 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function downloadExcel(jsonData, fileName) {
        const ws = XLSX.utils.json_to_sheet(jsonData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        XLSX.writeFile(wb, `${fileName}.xlsx`);
    }

    window.addEventListener('load', function() {
        initLanguage();
        init();
    });

    // Show print footer on print
    window.addEventListener('beforeprint', function() {
        document.querySelector('.print-footer').classList.remove('hidden');
    });
    
    window.addEventListener('afterprint', function() {
        document.querySelector('.print-footer').classList.add('hidden');
    });



    // ======== TRACKING SECTION ========
    const STORAGE_KEY_TRK = 'ims_tracking_data_v1';
    let trackingData = [];
    let currentTrackingFilter = 'all';

    function loadTracking() {
        const data = localStorage.getItem(STORAGE_KEY_TRK);
        if (data) {
            try {
                trackingData = JSON.parse(data);
            } catch(e) {
                console.error("Error loading tracking", e);
                trackingData = [];
            }
        }
    }

    function saveTracking() {
        localStorage.setItem(STORAGE_KEY_TRK, JSON.stringify(trackingData));
    }

    function renderTrackingTable() {
        const tbody = document.getElementById('tracking-table-body');
        const emptyState = document.getElementById('tracking-empty');
        if (!tbody) return;

        tbody.innerHTML = '';

        let filteredData = trackingData;
        if (currentTrackingFilter === 'pending') {
            filteredData = trackingData.filter(t => !t.delivered);
        } else if (currentTrackingFilter === 'delivered') {
            filteredData = trackingData.filter(t => t.delivered);
        }

        if (filteredData.length === 0) {
            emptyState.classList.remove('hidden');
            tbody.parentElement.classList.add('hidden');
        } else {
            emptyState.classList.add('hidden');
            tbody.parentElement.classList.remove('hidden');

            filteredData.forEach((item) => {
                const actualIdx = trackingData.indexOf(item);
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-brand-50 transition border-b border-slate-100';

                const statusBadges = {
                    'تم التحضير': '<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">تم التحضير</span>',
                    'بالمستودع': '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold">بالمستودع</span>',
                    'في الطريق': '<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-bold">في الطريق</span>',
                    'تم الاستلام': '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">تم الاستلام</span>'
                };

                const deliveredBadge = item.delivered ? 
                    '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">✅ نعم</span>' :
                    '<span class="px-2 py-1 bg-slate-100 text-slate-600 rounded-full text-xs font-bold">⏳ لا</span>';

                const lastUpdate = new Date(item.lastUpdate).toLocaleString('ar-SA', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                tr.innerHTML = `
                    <td class="p-3 font-mono font-bold text-brand-900">${item.orderId}</td>
                    <td class="p-3 font-mono text-slate-700">${item.shipmentNumber}</td>
                    <td class="p-3 text-center">${statusBadges[item.status] || item.status}</td>
                    <td class="p-3 text-center">${deliveredBadge}</td>
                    <td class="p-3 text-right text-xs text-slate-600">${item.notes || '-'}</td>
                    <td class="p-3 text-center text-xs text-slate-500">${lastUpdate}</td>
                    <td class="p-3 text-center no-print">
                        <button onclick="editTracking(${actualIdx})" class="px-2 py-1 bg-amber-100 hover:bg-amber-200 text-amber-700 rounded-lg font-bold text-xs mr-1 btn-pulse">
                            <i class="fa-solid fa-edit"></i>
                        </button>
                        <button onclick="deleteTracking(${actualIdx})" class="px-2 py-1 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg font-bold text-xs btn-pulse">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        updateTrackingCounts();
    }

    function updateTrackingCounts() {
        const all = trackingData.length;
        const pending = trackingData.filter(t => !t.delivered).length;
        const delivered = trackingData.filter(t => t.delivered).length;

        const countAll = document.getElementById('count-all');
        const countPending = document.getElementById('count-pending');
        const countDelivered = document.getElementById('count-delivered');
        const dashTrack = document.getElementById('dash-track-count');

        if (countAll) countAll.textContent = all;
        if (countPending) countPending.textContent = pending;
        if (countDelivered) countDelivered.textContent = delivered;
        if (dashTrack) dashTrack.textContent = pending;
    }

    function filterTracking(filter) {
        currentTrackingFilter = filter;

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('bg-brand-600', 'text-white');
            btn.classList.add('bg-slate-100', 'text-slate-600');
        });

        const activeBtn = document.getElementById(`filter-${filter}`);
        if (activeBtn) {
            activeBtn.classList.remove('bg-slate-100', 'text-slate-600');
            activeBtn.classList.add('bg-brand-600', 'text-white');
        }

        renderTrackingTable();
    }

    function resetTrackingForm() {
        const form = document.getElementById('trackingForm');
        if (form) {
            form.reset();
            delete form.dataset.editIdx;
            const submitText = document.getElementById('tracking-submit-text');
            if (submitText) submitText.textContent = 'حفظ بيانات الشحنة';
            showToast('تم تنظيف النموذج');
        }
    }

    function editTracking(idx) {
        const item = trackingData[idx];
        if (!item) return;

        document.getElementById('track-order-id').value = item.orderId;
        document.getElementById('track-shipment-number').value = item.shipmentNumber;
        document.getElementById('track-status').value = item.status;
        document.getElementById('track-notes').value = item.notes || '';
        document.getElementById('track-delivered').checked = item.delivered;
        document.getElementById('trackingForm').dataset.editIdx = idx;
        document.getElementById('tracking-submit-text').textContent = '💾 تحديث بيانات الشحنة';
        showToast('🔄 قيد التعديل - غير البيانات ثم انقر الحفظ');

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteTracking(idx) {
        const item = trackingData[idx];
        if (confirm(`هل أنت متأكد من حذف الشحنة:\n📦 رقم الطلب: ${item.orderId}\n📄 رقم البوليصة: ${item.shipmentNumber}`)) {
            trackingData.splice(idx, 1);
            saveTracking();
            updateDashboardStats();
            renderTrackingTable();
            showToast('🗑️ تم حذف الشحنة بنجاح');
        }
    }

    function exportTrackingExcel() {
        if (trackingData.length === 0) {
            showToast('❌ لا توجد بيانات شحنات للتصدير', 'error');
            return;
        }

        const data = trackingData.map(item => ({
            'رقم أمر الشراء': item.orderId,
            'رقم الفاتورة/البوليصة': item.shipmentNumber,
            'حالة الشحنة': item.status,
            'تم الاستلام': item.delivered ? '✅ نعم' : '⏳ لا',
            'ملاحظات': item.notes || '-',
            'آخر تحديث': new Date(item.lastUpdate).toLocaleString('ar-SA')
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        ws.columnWidths = [18, 18, 18, 12, 25, 20];
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'تتبع الشحنات');
        const filename = `تتبع_شحنات_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, filename);
        showToast('✅ تم تصدير البيانات بنجاح');
    }

    const trackingFormEl = document.getElementById('trackingForm');
    if (trackingFormEl) {
        trackingFormEl.onsubmit = function(e) {
            e.preventDefault();

            const tracking = {
                orderId: document.getElementById('track-order-id').value.trim(),
                shipmentNumber: document.getElementById('track-shipment-number').value.trim(),
                status: document.getElementById('track-status').value,
                notes: document.getElementById('track-notes').value.trim(),
                delivered: document.getElementById('track-delivered').checked,
                lastUpdate: new Date().toISOString()
            };

            if (!tracking.orderId || !tracking.shipmentNumber) {
                showToast('يرجى إدخال رقم الطلب ورقم البوليصة');
                return;
            }

            if (this.dataset.editIdx !== undefined && this.dataset.editIdx !== '') {
                trackingData[parseInt(this.dataset.editIdx)] = tracking;
                delete this.dataset.editIdx;
                document.getElementById('tracking-submit-text').textContent = 'حفظ بيانات الشحنة';
                showToast('✅ تم تحديث بيانات الشحنة بنجاح');
            } else {
                trackingData.push(tracking);
                showToast('✅ تمت إضافة الشحنة بنجاح وحفظها');
            }

            saveTracking();
            updateDashboardStats();
            renderTrackingTable();
            resetTrackingForm();
        };
    }

    // تهيئة التطبيق عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', function() {
        initLanguage();
        init();
    });

</script>
</body>
</html>